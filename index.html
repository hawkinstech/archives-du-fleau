<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archives du Fléau</title>
    
    <!-- FAVICON (Sceau Maudit) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><path d=%22M50 5 C20 35 0 55 0 80 C0 95 20 100 50 100 C80 100 100 95 100 80 C100 55 80 35 50 5 Z%22 fill=%22%23000%22/><path d=%22M50 15 C35 45 15 65 15 80 C15 90 30 95 50 95 C70 95 85 90 85 80 C85 65 65 45 50 15 Z%22 fill=%22%234c1d95%22/><path d=%22M50 30 C40 55 30 70 30 80 C30 85 40 90 50 90 C60 90 70 85 70 80 C70 70 60 55 50 30 Z%22 fill=%22%238b5cf6%22/><circle cx=%2250%22 cy=%2275%22 r=%225%22 fill=%22white%22/></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Oswald:wght@400;700&family=Rubik+Glitch&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { jjk: { black: '#0a0a0a', dark: '#121212', card: '#1a1a1a', purple: '#4c1d95', neon: '#8b5cf6', red: '#991b1b', blood: '#ef4444' } }, fontFamily: { oswald: ['Oswald', 'sans-serif'], cursed: ['Rubik Glitch', 'cursive'], body: ['Inter', 'sans-serif'], }, animation: { 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' } } } }
    </script>
    <style>
        body { background-color: #050505; background-image: radial-gradient(circle at 50% 0%, #1a0b2e 0%, #050505 60%); color: #e5e5e5; font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #0a0a0a; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: #8b5cf6; }
        .text-glow { text-shadow: 0 0 15px rgba(139, 92, 246, 0.4); }
        .king-glow { text-shadow: 0 0 15px rgba(220, 38, 38, 0.8); color: #ef4444; font-family: 'Rubik Glitch', cursive; letter-spacing: 2px; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 30px -10px rgba(139, 92, 246, 0.3); }
        .cropper-view-box, .cropper-face { border-radius: 50%; } .cropper-modal { opacity: 0.8; background-color: #000; }
        .admin-tab-active { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .yt-input { background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; width: 100%; font-size: 14px; transition: border-color 0.2s; }
        .yt-input:focus { border-color: #8b5cf6; outline: none; }
        .yt-label { display: block; font-size: 12px; color: #aaa; margin-bottom: 4px; font-weight: 600; text-transform: uppercase; }
        .banned-overlay { background: rgba(0, 0, 0, 0.9); border: 2px solid #991b1b; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; inset: 0; z-index: 20; }
    </style>
</head>
<body class="font-body overflow-x-hidden selection:bg-jjk-neon selection:text-white">

    <!-- HEADER -->
    <header class="fixed w-full z-50 bg-jjk-black/80 backdrop-blur-md border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-4">
                    <!-- LOGO SVG -->
                    <div class="w-10 h-10 bg-black rounded-lg flex items-center justify-center border border-jjk-purple/50 shadow-[0_0_15px_rgba(139,92,246,0.3)] overflow-hidden relative group">
                        <svg viewBox="0 0 100 100" class="w-full h-full transform group-hover:scale-110 transition-transform duration-500">
                            <path d="M50 0 C20 30 0 50 0 75 C0 90 20 100 50 100 C80 100 100 90 100 75 C100 50 80 30 50 0 Z" fill="#000"/>
                            <path d="M50 10 C30 40 10 60 10 80 C10 90 25 95 50 95 C75 95 90 90 90 80 C90 60 70 40 50 10 Z" fill="#4c1d95" class="animate-pulse"/>
                            <path d="M50 25 C40 55 25 70 25 80 C25 88 35 90 50 90 C65 90 75 88 75 80 C75 70 60 55 50 25 Z" fill="#8b5cf6"/>
                            <circle cx="50" cy="80" r="3" fill="white" class="animate-ping"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="font-oswald text-2xl text-white tracking-widest uppercase font-bold">Archives</h1>
                        <span class="text-[10px] text-gray-400 font-mono tracking-widest block -mt-1 uppercase">Du Fléau</span>
                    </div>
                </div>
                
                <!-- Desktop Nav -->
                <div class="hidden md:flex items-center gap-6">
                    <button onclick="openMembersModal()" class="flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white transition-colors">
                        <i data-lucide="users" class="w-4 h-4"></i> Membres
                    </button>

                    <button id="publish-btn" class="hidden flex items-center gap-2 text-sm font-bold text-white bg-white/10 border border-white/50 px-4 py-2 rounded-full shadow-[0_0_15px_rgba(255,255,255,0.2)] hover:shadow-[0_0_25px_rgba(255,255,255,0.5)] hover:bg-white/20 transition-all" onclick="openEditor('create')">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> Publier
                    </button>

                    <button id="admin-link" class="hidden text-red-500 font-oswald uppercase tracking-wider hover:text-red-400 flex items-center gap-2" onclick="openAdminPanel()">
                        <i data-lucide="shield-alert" class="w-4 h-4"></i> Admin
                    </button>

                    <div id="auth-buttons">
                        <button onclick="openAuthModal()" class="text-sm font-medium text-white/80 hover:text-white transition-colors bg-white/5 hover:bg-white/10 px-5 py-2 rounded-full border border-white/5">
                            Connexion
                        </button>
                    </div>
                    
                    <div id="user-profile-btn" class="hidden flex items-center gap-3 cursor-pointer group" onclick="openProfileModal()">
                        <div class="text-right">
                            <p class="text-white font-medium text-sm group-hover:text-jjk-neon transition-colors" id="header-username">User</p>
                            <p class="text-[10px] text-gray-500 uppercase tracking-wider font-bold" id="header-role">Grade 4</p>
                        </div>
                        <img id="header-avatar" src="" class="w-10 h-10 rounded-full border border-white/10 group-hover:border-jjk-neon transition-all object-cover bg-black">
                    </div>
                </div>

                <button class="md:hidden text-white" onclick="toggleSidebar()"><i data-lucide="menu"></i></button>
            </div>
        </div>
    </header>

    <div class="flex pt-20 min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 w-64 bg-jjk-black border-r border-white/5 transition-transform duration-300 ease-in-out z-40 pt-24 md:pt-0">
            <div class="p-6">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-6">Navigation</h2>
                <nav class="space-y-1" id="category-list"></nav>
                <button onclick="openMembersModal(); toggleSidebar()" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 text-gray-400 hover:bg-white/5 hover:text-white mt-4 border-t border-white/5 pt-4">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span class="font-medium text-sm tracking-wide">Liste des Membres</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 p-6 lg:p-10 relative">
            <div class="relative z-10 mb-10 flex flex-col md:flex-row justify-between items-end gap-4 border-b border-white/5 pb-6">
                <div>
                    <h2 id="current-category-title" class="text-4xl font-oswald font-bold text-white mb-2 uppercase">Archives</h2>
                    <p class="text-gray-400 text-sm max-w-md">Accédez aux enregistrements des combats et techniques maudites.</p>
                </div>
                <div class="relative w-full md:w-auto">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i>
                    <input type="text" id="search-input" placeholder="Rechercher une archive..." class="bg-jjk-card border border-white/5 text-white pl-10 pr-4 py-2 rounded-lg focus:outline-none focus:border-jjk-neon w-full md:w-64 text-sm transition-all">
                </div>
            </div>
            <div id="video-grid" class="relative z-10 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-center opacity-50">
                <i data-lucide="ghost" class="w-12 h-12 mb-4"></i>
                <p>Aucune donnée trouvée.</p>
            </div>
        </main>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- 1. AUTH MODAL -->
    <div id="auth-modal" class="fixed inset-0 z-[130] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-jjk-card border border-white/10 w-full max-w-sm rounded-2xl p-8 shadow-2xl relative">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="flex gap-6 mb-8 text-sm font-bold uppercase tracking-wider">
                <button onclick="switchAuthTab('login')" id="tab-login" class="pb-2 text-jjk-neon border-b-2 border-jjk-neon">Connexion</button>
                <button onclick="switchAuthTab('signup')" id="tab-signup" class="pb-2 text-gray-500 hover:text-white">Inscription</button>
            </div>
            <div id="form-login" class="space-y-4">
                <input type="text" id="login-username" placeholder="Pseudo" class="w-full bg-black border border-white/10 rounded-lg p-3 text-white focus:border-jjk-neon outline-none text-sm">
                <div class="relative"><input type="password" id="login-password" placeholder="Mot de passe" class="w-full bg-black border border-white/10 rounded-lg p-3 text-white focus:border-jjk-neon outline-none text-sm pr-10"><button onclick="togglePassword('login-password', this)" class="absolute right-3 top-3 text-gray-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button></div>
                <button onclick="handleLogin()" class="w-full bg-jjk-purple hover:bg-jjk-neon text-white font-bold py-3 rounded-lg text-sm uppercase tracking-wide transition-all">Entrer</button>
            </div>
            <div id="form-signup" class="space-y-4 hidden">
                <input type="text" id="signup-username" placeholder="Pseudo" class="w-full bg-black border border-white/10 rounded-lg p-3 text-white focus:border-jjk-neon outline-none text-sm">
                <div class="relative"><input type="password" id="signup-password" placeholder="Mot de passe" class="w-full bg-black border border-white/10 rounded-lg p-3 text-white focus:border-jjk-neon outline-none text-sm pr-10"><button onclick="togglePassword('signup-password', this)" class="absolute right-3 top-3 text-gray-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button></div>
                <button onclick="handleSignup()" class="w-full bg-white text-black hover:bg-gray-200 font-bold py-3 rounded-lg text-sm uppercase tracking-wide transition-all">S'inscrire</button>
            </div>
            <p id="auth-msg" class="mt-4 text-center text-xs text-red-400 min-h-[1.5em]"></p>
        </div>
    </div>

    <!-- 2. VIDEO PLAYER MODAL -->
    <div id="video-modal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl hidden flex items-center justify-center p-0 md:p-6">
        <div class="bg-jjk-card border border-white/10 w-full max-w-[90rem] h-full md:h-[90vh] md:rounded-2xl shadow-2xl overflow-hidden relative flex flex-col md:flex-row">
            <button onclick="closeModal()" class="absolute top-4 right-4 z-50 text-white bg-black/50 p-2 rounded-full md:hidden"><i data-lucide="x"></i></button>
            <div class="w-full md:w-[70%] bg-black flex flex-col">
                <div class="flex-1 relative flex items-center justify-center bg-black" id="modal-player-container"></div>
                <div class="p-4 border-b border-white/5 bg-jjk-card flex justify-between items-start">
                    <div><h3 id="modal-title" class="text-xl font-oswald text-white uppercase font-bold leading-tight"></h3><div class="flex flex-wrap gap-2 mt-2" id="modal-tags"></div></div>
                    <div class="flex items-center gap-2 bg-black/30 rounded-full p-1 border border-white/5">
                        <button onclick="handleVideoLike('like')" id="btn-like" class="flex items-center gap-2 px-3 py-1.5 rounded-full hover:bg-white/10 transition-colors text-gray-400"><i data-lucide="thumbs-up" class="w-4 h-4"></i> <span id="likes-count" class="text-xs font-bold">0</span></button>
                        <div class="w-[1px] h-4 bg-white/10"></div>
                        <button onclick="handleVideoLike('dislike')" id="btn-dislike" class="flex items-center gap-2 px-3 py-1.5 rounded-full hover:bg-white/10 transition-colors text-gray-400"><i data-lucide="thumbs-down" class="w-4 h-4"></i> <span id="dislikes-count" class="text-xs font-bold">0</span></button>
                    </div>
                </div>
            </div>
            <div class="w-full md:w-[30%] bg-jjk-card border-l border-white/5 flex flex-col h-full">
                <div class="p-4 border-b border-white/5 flex justify-between items-center hidden md:flex"><span class="text-xs font-bold text-gray-500 uppercase">Discussion</span><button onclick="closeModal()" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                <div class="flex-1 overflow-y-auto p-4 custom-scrollbar"><p id="modal-desc" class="text-gray-400 text-sm leading-relaxed mb-6 pb-6 border-b border-white/5"></p><div id="video-comment-auth" class="mb-6"></div><div id="comments-list" class="space-y-6"></div></div>
            </div>
        </div>
    </div>

    <!-- 3. EDITOR MODAL (STUDIO) -->
    <div id="editor-modal" class="fixed inset-0 z-[120] bg-black/95 backdrop-blur-xl hidden flex items-center justify-center p-0 md:p-6">
        <div class="bg-jjk-card border border-white/10 w-full max-w-[90rem] h-full md:h-[90vh] md:rounded-2xl shadow-2xl overflow-hidden relative flex flex-col md:flex-row">
            <button onclick="closeEditor()" class="absolute top-4 right-4 z-50 text-white bg-black/50 p-2 rounded-full md:hidden"><i data-lucide="x"></i></button>
            <div class="w-full md:w-[60%] bg-black flex flex-col border-r border-white/5">
                <div class="flex-1 relative flex items-center justify-center bg-black overflow-hidden" id="editor-preview-container"><p class="text-gray-600">Aperçu de la vidéo</p></div>
                <div class="p-6 bg-black/50 border-t border-white/5">
                    <h3 class="text-gray-500 text-xs uppercase font-bold mb-2">Aperçu Miniature</h3>
                    <div class="w-40 aspect-video bg-gray-800 rounded overflow-hidden relative group"><img id="preview-thumb" src="" class="w-full h-full object-cover opacity-50"><div class="absolute inset-0 flex items-center justify-center"><i data-lucide="image" class="w-6 h-6 text-white"></i></div></div>
                </div>
            </div>
            <div class="w-full md:w-[40%] bg-jjk-card flex flex-col h-full">
                <div class="p-6 border-b border-white/5 flex justify-between items-center">
                    <h2 id="editor-title" class="text-xl font-oswald text-white uppercase font-bold">Publier une vidéo</h2>
                    <div class="flex gap-2">
                        <button onclick="closeEditor()" class="text-gray-400 hover:text-white px-3 py-1 text-sm">Annuler</button>
                        <button onclick="handleSaveEditor()" class="bg-jjk-purple hover:bg-jjk-neon text-white px-5 py-2 rounded-md text-sm font-bold uppercase tracking-wide transition-all shadow-lg shadow-purple-900/20">Enregistrer</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-5">
                    <input type="hidden" id="editor-id">
                    <div><label class="yt-label">Titre (requis)</label><input type="text" id="editor-input-title" class="yt-input" placeholder="Titre de la vidéo..."></div>
                    <div><label class="yt-label">Description</label><textarea id="editor-input-desc" class="yt-input h-32 resize-none" placeholder="Parlez de votre vidéo aux spectateurs..."></textarea></div>
                    <div class="grid grid-cols-1 gap-5">
                        <div><label class="yt-label">Lien Vidéo (Google Drive / MP4)</label><div class="relative"><input type="text" id="editor-input-url" class="yt-input pl-10" placeholder="https://..." oninput="updateEditorPreview()"><i data-lucide="link" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i></div></div>
                        <div><label class="yt-label">Miniature (URL Image)</label><div class="relative"><input type="text" id="editor-input-thumb" class="yt-input pl-10" placeholder="https://..." oninput="updateEditorPreview()"><i data-lucide="image" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i></div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="yt-label">Catégorie</label><select id="editor-input-cat" class="yt-input appearance-none cursor-pointer"><option value="vs_all">Vs All</option><option value="vs_people">Vs People</option></select></div>
                        <div><label class="yt-label">Tags</label><input type="text" id="editor-input-tags" class="yt-input" placeholder="Ex: Gojo, Sukuna..."></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. MEMBERS MODAL -->
    <div id="members-modal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-jjk-card border border-white/10 w-full max-w-4xl h-[85vh] rounded-2xl shadow-2xl relative flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-white/10 shrink-0">
                <h2 class="text-2xl font-oswald text-white uppercase font-bold">Membres</h2>
                <button onclick="closeMembersModal()" class="bg-white/5 p-2 rounded-full text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar"><div id="members-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div></div>
        </div>
    </div>

    <!-- 5. MY PROFILE MODAL -->
    <div id="profile-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-jjk-card border border-white/10 w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl relative">
            <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-white z-10 bg-black/50 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="h-32 bg-gradient-to-r from-jjk-purple to-indigo-900"></div>
            <div class="px-8 pb-8 -mt-12">
                <div class="relative inline-block group">
                    <img id="profile-avatar-preview" src="" class="w-24 h-24 rounded-full border-4 border-jjk-card object-cover bg-black cursor-pointer" onclick="document.getElementById('file-upload').click()">
                    <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer pointer-events-none transition-opacity"><i data-lucide="camera" class="text-white w-6 h-6"></i></div>
                    <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                </div>
                <div id="crop-container" class="hidden mt-4 bg-black p-4 rounded-lg border border-white/10">
                    <div class="h-64 w-full"><img id="image-to-crop" class="max-w-full max-h-full block"></div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button onclick="cancelCrop()" class="px-3 py-1 text-xs text-gray-400 border border-white/10 rounded">Annuler</button>
                        <button onclick="applyCrop()" class="px-3 py-1 text-xs bg-white text-black rounded font-bold">Valider</button>
                    </div>
                </div>
                <div class="mt-6 space-y-4">
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Pseudo</label><input type="text" id="edit-username" class="w-full bg-black/50 border border-white/10 rounded p-2 text-white text-sm mt-1 focus:border-jjk-neon outline-none"></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Mot de passe (Laisser vide si inchangé)</label><div class="relative"><input type="password" id="edit-password" class="w-full bg-black/50 border border-white/10 rounded p-2 text-white text-sm mt-1 focus:border-jjk-neon outline-none pr-10"><button onclick="togglePassword('edit-password', this)" class="absolute right-3 top-3 text-gray-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button></div></div>
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Bio</label><textarea id="edit-bio" rows="3" class="w-full bg-black/50 border border-white/10 rounded p-2 text-white text-sm mt-1 focus:border-jjk-neon outline-none resize-none"></textarea></div>
                    <div class="flex gap-3 pt-4"><button onclick="saveProfile()" class="flex-1 bg-white text-black py-2.5 rounded-lg font-bold text-sm hover:bg-gray-200 transition-colors">Sauvegarder</button><button onclick="handleLogout()" class="px-4 border border-red-900/50 text-red-500 hover:bg-red-900/10 rounded-lg text-sm font-medium transition-colors">Déconnexion</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. PUBLIC PROFILE MODAL (With Admin Actions) -->
    <div id="public-profile-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4">
        <div class="bg-jjk-card border border-white/10 w-full max-w-2xl max-h-[90vh] rounded-2xl overflow-hidden shadow-2xl relative flex flex-col">
            <button onclick="closePublicProfile()" class="absolute top-4 right-4 text-white z-10 bg-black/50 p-1 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="overflow-y-auto flex-1 custom-scrollbar">
                <div class="h-32 bg-gradient-to-r from-gray-900 to-jjk-dark"></div>
                <div class="px-8 pb-8 -mt-12">
                    <img id="public-avatar" src="" class="w-24 h-24 rounded-full border-4 border-jjk-card object-cover bg-black">
                    <div class="mt-4">
                        <div class="flex items-center gap-3">
                            <h2 id="public-username" class="text-2xl font-oswald text-white font-bold"></h2>
                            <span id="public-role" class="px-2 py-0.5 rounded text-[10px] uppercase font-bold bg-white/10 text-gray-400">Membre</span>
                        </div>
                        <p id="public-bio" class="text-gray-400 text-sm mt-2 leading-relaxed"></p>
                        <p id="public-date" class="text-xs text-gray-600 mt-2 font-mono"></p>
                        
                        <!-- ADMIN ACTION BUTTONS ON PROFILE -->
                        <div id="public-profile-admin-actions" class="mt-4 flex gap-2 hidden"></div>
                    </div>
                    <div class="mt-8 pt-8 border-t border-white/5">
                        <h3 class="text-sm font-bold text-white uppercase tracking-wider mb-4">Mur de messages</h3>
                        <div id="profile-comment-auth"></div>
                        <div id="profile-comments-list" class="space-y-4 mt-6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. ADMIN PANEL -->
    <div id="admin-panel" class="fixed inset-0 z-[110] bg-black/95 hidden flex flex-col p-4 md:p-10">
        <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
            <h2 class="text-3xl font-oswald text-red-500 uppercase font-bold flex items-center gap-3"><i data-lucide="shield-alert"></i> Administration</h2>
            <button onclick="closeAdminPanel()" class="bg-white/10 hover:bg-white/20 p-2 rounded-full text-white"><i data-lucide="x"></i></button>
        </div>
        <div class="flex gap-4 mb-6">
            <button onclick="switchAdminTab('users')" id="admin-tab-users" class="px-4 py-2 rounded text-sm font-bold uppercase transition-all admin-tab-active">Utilisateurs</button>
            <button onclick="switchAdminTab('videos')" id="admin-tab-videos" class="px-4 py-2 rounded text-sm font-bold uppercase transition-all bg-white/5 text-gray-400 hover:text-white">Vidéos</button>
        </div>
        <div class="flex-1 overflow-auto bg-jjk-card border border-white/10 rounded-xl p-6 relative">
            <div id="admin-section-users">
                <table class="w-full text-left border-collapse">
                    <thead><tr class="text-xs font-bold text-gray-500 uppercase border-b border-white/10"><th class="pb-3 pl-2">ID</th><th class="pb-3">Utilisateur</th><th class="pb-3">Rôle</th><th class="pb-3 text-right">Actions</th></tr></thead>
                    <tbody id="admin-user-list" class="text-sm text-gray-300"></tbody>
                </table>
            </div>
            <div id="admin-section-videos" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-white font-bold">Gestion des contenus</h3>
                    <button onclick="openEditor('create')" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded text-xs font-bold flex items-center gap-2"><i data-lucide="plus"></i> Ajouter</button>
                </div>
                <div id="admin-video-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        let user = null;
        let currentCategory = 'all';
        let searchQuery = '';
        let currentVideoId = null;
        let currentProfileId = null; 
        let cropper = null;
        let pendingAvatarBase64 = null;
        let videos = []; 

        const DEFAULT_AVATAR = "https://cdn.discordapp.com/attachments/990311724433408070/1445953911243411718/36280654-defaut-avatar-profil-icone-social-medias-utilisateur-image-gris-avatar-icone-vide-profil-silhouette-vecteur-illustration-vectoriel.jpg?ex=69323904&is=6930e784&hm=6beb888efc47cf175779fc766de696bc9c65e9a62a9f201d9a6e331723716798&";
        
        const categories = [{ id: 'all', name: 'Toutes les archives', icon: 'layers' },{ id: 'vs_all', name: 'Vs All', icon: 'swords' },{ id: 'vs_people', name: 'Vs People', icon: 'users' }];

        const defaultVideos = [
            { id: 101, title: "Kawai vs HaWkiNs", categories: ["vs_people"], url: "https://drive.google.com/file/d/1Obg7Xa1X3EzJq6fL0AyOShVVXsFP7oz7/view?usp=drive_link", thumbnail: "https://cdn.discordapp.com/attachments/1083887088514109470/1445916750582517780/Capture_decran_2025-12-04_001631.png?ex=69321669&is=6930c4e9&hm=10329d6958e67c2446f7e575f82d372a73e247dfed7f9883b6028f7d4abbfd74&", duration: "VIDEO", views: "New", tags: ["Kawai", "Hawkins", "Duel"], desc: "Vidéo Kawai Vs Hawkins. Le combat au sommet." },
            { id: 102, title: "HaWkiNs vs 8 Commandants", categories: ["vs_all"], url: "https://drive.google.com/file/d/1gA8Ig-caMeriNOjb0WqftMHqUVi6_hdA/view?usp=drive_link", thumbnail: "https://cdn.discordapp.com/attachments/990311724433408070/1445920141375307826/image.png?ex=69321991&is=6930c811&hm=ecf890cdd880e85471d1fe073943ec26e5b377c38443f9f557bc8878bd5b0d4c&", duration: "VIDEO", views: "New", tags: ["hawkins", "kawai", "torchy", "kordex", "net", "lyns", "Brk", "Wada", "moussa"], desc: "L'édit ultime. Hawkins affronte les 8 commandants." },
            { id: 103, title: "HaWkiNs vs Torchy", categories: ["vs_people"], url: "https://drive.google.com/file/d/10Zdu7ejXAz0bgiVXKwf5R_xRXzvbiLsw/view?usp=drive_link", thumbnail: "https://cdn.discordapp.com/attachments/990311724433408070/1445921999523287260/image.png?ex=69321b4c&is=6930c9cc&hm=b3b715b9f1d066d6d026e4791d1a26d631069f47da9e85ed26818308936cba3c&", duration: "VIDEO", views: "New", tags: ["Hawkins", "Torchy", "Duel"], desc: "Le duel intense entre Hawkins et Torchy." }
        ];

        async function initApp() {
            const storedUser = localStorage.getItem('jjk_user');
            if (storedUser) { 
                user = JSON.parse(storedUser); 
                updateUIForUser(); 
                try {
                    const res = await fetch(`/api/users?id=${user.id}`);
                    if (res.ok) {
                        const freshData = await res.json();
                        user = { ...user, ...freshData };
                        localStorage.setItem('jjk_user', JSON.stringify(user));
                        updateUIForUser();
                    } else if (res.status === 404) {
                        // L'UTILISATEUR N'EXISTE PLUS DANS LA DB -> EJECTION
                        handleLogout();
                    }
                } catch (e) { console.log("Offline"); }
            }
            await loadVideos();
            renderCategories();
            lucide.createIcons();
        }

        async function loadVideos() {
            try {
                const res = await fetch('/api/videos');
                if (!res.ok) throw new Error("Backend non dispo");
                videos = await res.json();
            } catch(e) { console.warn("Fallback videos"); videos = defaultVideos; }
            renderVideos();
        }
        
        function getRoleLabel(role) {
            if (role === 'super_admin') return "Roi des Ténèbres";
            if (role === 'admin') return "Admin";
            if (role === 'moderator') return "Modérateur";
            return "Membre";
        }
        
        function getRoleClass(role) {
            if (role === 'super_admin') return "king-glow text-lg";
            if (role === 'admin') return "text-red-500 font-bold uppercase tracking-wider";
            if (role === 'moderator') return "text-blue-400 font-bold uppercase tracking-wider";
            return "text-gray-500 uppercase tracking-wider font-bold";
        }

        function updateUIForUser() {
            const authBtns = document.getElementById('auth-buttons');
            const profileBtn = document.getElementById('user-profile-btn');
            const adminLink = document.getElementById('admin-link');
            const publishBtn = document.getElementById('publish-btn');

            if (user) {
                authBtns.classList.add('hidden'); profileBtn.classList.remove('hidden'); profileBtn.classList.add('flex');
                document.getElementById('header-username').textContent = user.username;
                
                const roleEl = document.getElementById('header-role');
                roleEl.textContent = getRoleLabel(user.role);
                roleEl.className = "text-[10px] " + getRoleClass(user.role);

                document.getElementById('header-avatar').src = user.avatar_url || DEFAULT_AVATAR;
                
                if (user.role === 'admin' || user.role === 'super_admin' || user.role === 'moderator') {
                    adminLink.classList.remove('hidden');
                    if (user.role !== 'moderator') {
                        publishBtn.classList.remove('hidden');
                        publishBtn.classList.add('flex');
                    }
                } else {
                    adminLink.classList.add('hidden');
                    publishBtn.classList.add('hidden');
                    publishBtn.classList.remove('flex');
                }
            } else {
                authBtns.classList.remove('hidden'); profileBtn.classList.add('hidden'); profileBtn.classList.remove('flex'); 
                adminLink.classList.add('hidden');
                publishBtn.classList.add('hidden');
                publishBtn.classList.remove('flex');
            }
        }

        function renderCommentInput(context) {
            const containerId = context === 'video' ? 'video-comment-auth' : 'profile-comment-auth';
            const container = document.getElementById(containerId);
            if (!container) return;
            if (user) {
                if (user.is_muted) {
                     container.innerHTML = `<div class="bg-red-900/20 border border-red-900 rounded-lg p-4 text-center"><p class="text-sm text-red-500 mb-2 font-bold uppercase tracking-wider">Réduit au silence</p><p class="text-xs text-red-400">Vous ne pouvez plus écrire de messages.</p></div>`;
                } else if (user.is_banned) {
                     container.innerHTML = `<div class="bg-red-900/20 border border-red-900 rounded-lg p-4 text-center"><p class="text-sm text-red-500 mb-2 font-bold uppercase tracking-wider">Compte Banni</p></div>`;
                } else {
                    container.innerHTML = `<div class="flex gap-3"><img src="${user.avatar_url || DEFAULT_AVATAR}" class="w-8 h-8 rounded-full object-cover shrink-0"><div class="flex-1"><textarea id="${context}-input" rows="1" placeholder="Ajouter un commentaire..." class="w-full bg-transparent border-b border-white/20 text-white text-sm focus:border-jjk-neon focus:outline-none py-2 resize-none transition-all focus:bg-white/5 p-2 rounded-t"></textarea><div class="flex justify-end mt-2"><button onclick="postComment('${context}')" class="text-xs bg-white text-black font-bold px-4 py-1.5 rounded-full hover:bg-gray-200 transition-colors">Envoyer</button></div></div></div>`;
                }
            }
            else { container.innerHTML = `<div class="bg-white/5 rounded-lg p-4 text-center"><p class="text-sm text-gray-400 mb-2">Connectez-vous pour participer</p><button onclick="${context === 'video' ? 'closeModal();' : 'closePublicProfile();'} openAuthModal()" class="text-xs border border-white/20 px-4 py-1.5 rounded-full hover:bg-white hover:text-black transition-colors">Se connecter</button></div>`; }
        }

        function renderCategories() {
            const nav = document.getElementById('category-list');
            nav.innerHTML = categories.map(cat => `<button onclick="setCategory('${cat.id}')" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 transition-all duration-300 ${currentCategory === cat.id ? 'bg-white/10 text-white font-bold border-l-2 border-jjk-neon' : 'text-gray-400 hover:bg-white/5 hover:text-white'}"><i data-lucide="${cat.icon}" class="w-4 h-4"></i><span class="font-medium text-sm tracking-wide">${cat.name}</span></button>`).join('');
            lucide.createIcons();
        }
        function renderVideos() {
            const grid = document.getElementById('video-grid');
            const filtered = videos.filter(v => (currentCategory === 'all' || v.categories.includes(currentCategory)) && v.title.toLowerCase().includes(searchQuery.toLowerCase()));
            if (filtered.length === 0) { grid.innerHTML = ''; document.getElementById('empty-state').classList.remove('hidden'); return; }
            document.getElementById('empty-state').classList.add('hidden');
            
            const isAdmin = user && (user.role === 'admin' || user.role === 'super_admin');
            const isBanned = user && user.is_banned;
            
            grid.innerHTML = filtered.map((v, i) => `
                <div class="group bg-jjk-card border border-white/5 rounded-xl overflow-hidden card-hover transition-all duration-300 cursor-pointer relative" onclick="openModal(${v.id})" style="animation: fadeUp 0.5s ease-out ${i*0.1}s backwards">
                    <div class="relative aspect-video overflow-hidden">
                        <img src="${v.thumbnail}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">
                        
                        <!-- BAN OVERLAY LOGIC -->
                        ${isBanned ? 
                        `<div class="banned-overlay">
                            <i data-lucide="lock" class="w-10 h-10 text-red-600 mb-2"></i>
                            <span class="text-red-600 font-oswald uppercase tracking-widest text-lg font-bold text-glow">VOUS ÊTES BANNI</span>
                         </div>` 
                        : 
                        `<div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors"></div>
                         <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="bg-white/10 backdrop-blur-md p-3 rounded-full border border-white/20">
                                <i data-lucide="play" class="w-6 h-6 text-white fill-white"></i>
                            </div>
                         </div>`
                        }

                        ${isAdmin ? `
                        <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                            <button onclick="event.stopPropagation(); editVideo(${v.id});" class="bg-blue-600/80 p-1.5 rounded-full hover:bg-blue-500 text-white shadow-lg backdrop-blur-sm border border-white/20"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                            <button onclick="event.stopPropagation(); deleteVideo(${v.id})" class="bg-red-600/80 p-1.5 rounded-full hover:bg-red-500 text-white shadow-lg backdrop-blur-sm border border-white/20"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>` : ''}
                    </div>
                    <div class="p-4"><h3 class="text-white font-bold text-lg leading-tight mb-2 line-clamp-1 group-hover:text-jjk-neon transition-colors">${v.title}</h3><div class="flex flex-wrap gap-2 mt-3">${v.tags && v.tags.length ? v.tags.slice(0,2).map(t => `<span class="text-[10px] uppercase font-bold px-2 py-1 bg-white/5 text-gray-400 rounded border border-white/5">${t}</span>`).join('') : ''}</div></div>
                </div>`).join('');
            lucide.createIcons();
        }
        function setCategory(id) { currentCategory = id; renderCategories(); renderVideos(); toggleSidebar(); }
        function openModal(id) {
            // SI BANNI, ON BLOQUE L'OUVERTURE
            if (user && user.is_banned) {
                return; // Ne fait rien (le cadenas visuel suffit, ou on peut ajouter un alert)
            }

            currentVideoId = id; const v = videos.find(v => v.id === id);
            document.getElementById('modal-title').textContent = v.title; document.getElementById('modal-desc').textContent = v.description || "";
            document.getElementById('modal-tags').innerHTML = v.tags ? v.tags.map(t => `<span class="px-2 py-1 bg-white/10 text-xs rounded">${t}</span>`).join('') : '';
            const player = document.getElementById('modal-player-container');
            if (v.url.includes('drive.google.com')) { const embed = v.url.replace('/view', '/preview').replace('usp=drive_link', ''); player.innerHTML = `<iframe src="${embed}" width="100%" height="100%" class="absolute inset-0" frameborder="0" allowfullscreen></iframe>`; } 
            else { player.innerHTML = '<p class="text-white">Video Error</p>'; }
            renderCommentInput('video'); loadComments(id); loadVideoStats(id);
            document.getElementById('video-modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('video-modal').classList.add('hidden'); document.getElementById('modal-player-container').innerHTML = ''; }

        function openEditor(mode) {
            closeAdminPanel();
            document.getElementById('editor-modal').classList.remove('hidden');
            const title = document.getElementById('editor-title');
            if (mode === 'create') { title.textContent = "Publier une vidéo"; resetVideoForm(); } 
            else { title.textContent = "Modifier la vidéo"; }
            updateEditorPreview();
        }
        function closeEditor() {
            document.getElementById('editor-modal').classList.add('hidden');
            document.getElementById('editor-preview-container').innerHTML = '<p class="text-gray-600">Aperçu de la vidéo</p>';
        }
        function updateEditorPreview() {
            const url = document.getElementById('editor-input-url').value;
            const thumb = document.getElementById('editor-input-thumb').value;
            const previewContainer = document.getElementById('editor-preview-container');
            const thumbPreview = document.getElementById('preview-thumb');
            if (thumb) { thumbPreview.src = thumb; thumbPreview.classList.remove('opacity-50'); } else { thumbPreview.src = ""; thumbPreview.classList.add('opacity-50'); }
            if (url && url.includes('drive.google.com')) { const embed = url.replace('/view', '/preview').replace('usp=drive_link', ''); previewContainer.innerHTML = `<iframe src="${embed}" width="100%" height="100%" class="absolute inset-0" frameborder="0" allowfullscreen></iframe>`; } else { previewContainer.innerHTML = '<p class="text-gray-600">Aperçu vidéo non disponible (Lien Drive requis)</p>'; }
        }
        async function handleSaveEditor() {
             const id = document.getElementById('editor-id').value;
             const payload = {
                id: id ? parseInt(id) : null, title: document.getElementById('editor-input-title').value, description: document.getElementById('editor-input-desc').value,
                url: document.getElementById('editor-input-url').value, thumbnail: document.getElementById('editor-input-thumb').value,
                categories: [document.getElementById('editor-input-cat').value], tags: document.getElementById('editor-input-tags').value.split(',').map(t => t.trim())
            };
            const method = id ? 'PUT' : 'POST';
            try { 
                const res = await fetch('/api/videos', { 
                    method, 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                }); 
                if(!res.ok) throw new Error(await res.text());
                await loadVideos();
            } catch(e) { 
                console.warn("Mode simulation: Mise à jour locale forcée");
                if (id) { const index = videos.findIndex(v => v.id === parseInt(id)); if (index !== -1) videos[index] = { ...videos[index], ...payload, id: parseInt(id) }; } 
                else { videos.unshift({ ...payload, id: Date.now() }); }
            }
            closeEditor(); renderVideos(); alert("Vidéo enregistrée !");
        }

        function openAdminPanel() {
            if (!user || (user.role !== 'admin' && user.role !== 'super_admin' && user.role !== 'moderator')) return;
            document.getElementById('admin-panel').classList.remove('hidden');
            switchAdminTab('users');
        }
        function closeAdminPanel() { document.getElementById('admin-panel').classList.add('hidden'); }
        function switchAdminTab(tab) {
            document.getElementById('admin-section-users').classList.toggle('hidden', tab !== 'users');
            document.getElementById('admin-section-videos').classList.toggle('hidden', tab !== 'videos');
            document.getElementById('admin-tab-users').className = tab==='users' ? "px-4 py-2 rounded text-sm font-bold uppercase transition-all admin-tab-active" : "px-4 py-2 rounded text-sm font-bold uppercase transition-all bg-white/5 text-gray-400 hover:text-white";
            
            if (user.role === 'moderator') { document.getElementById('admin-tab-videos').style.display = 'none'; } else { document.getElementById('admin-tab-videos').className = tab==='videos' ? "px-4 py-2 rounded text-sm font-bold uppercase transition-all admin-tab-active" : "px-4 py-2 rounded text-sm font-bold uppercase transition-all bg-white/5 text-gray-400 hover:text-white"; }
            if(tab === 'users') loadAdminUsers(); if(tab === 'videos') loadAdminVideos();
        }
        async function loadAdminUsers() {
            const list = document.getElementById('admin-user-list'); list.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Chargement...</td></tr>';
            let users = [];
            try { 
                const res = await fetch('/api/users?type=list'); 
                if (!res.ok) throw new Error("Fetch failed"); 
                users = await res.json(); 
            } catch (e) { users = []; }
            list.innerHTML = users.map(u => {
                let canManage = false;
                if (user.role === 'super_admin') canManage = true;
                else if (user.role === 'admin' && u.role !== 'super_admin' && u.role !== 'admin') canManage = true;
                else if (user.role === 'moderator' && u.role === 'user') canManage = true;
                let roleSelector = `<span class="px-2 py-1 rounded text-xs ${u.role==='super_admin'?'king-glow':(u.role==='admin'?'bg-red-500/20 text-red-400':(u.role==='moderator'?'bg-blue-500/20 text-blue-400':'bg-white/5 text-gray-400'))}">${getRoleLabel(u.role)}</span>`;
                if (canManage && (user.role === 'super_admin' || (user.role === 'admin' && u.role !== 'admin'))) {
                     roleSelector = `<select onchange="changeRole(${u.id}, this.value)" class="bg-black border border-white/20 text-xs rounded p-1"><option value="user" ${u.role==='user'?'selected':''}>Membre</option><option value="moderator" ${u.role==='moderator'?'selected':''}>Modérateur</option><option value="admin" ${u.role==='admin'?'selected':''}>Admin</option></select>`;
                }
                return `<tr class="border-b border-white/5 hover:bg-white/5 transition-colors ${u.is_banned ? 'opacity-50' : ''}"><td class="py-3 pl-2 font-mono text-gray-500">#${u.id}</td><td class="py-3 flex items-center gap-3"><img src="${u.avatar_url || DEFAULT_AVATAR}" class="w-8 h-8 rounded-full bg-black object-cover"><span class="font-bold text-white">${u.username}</span>${u.is_banned ? '<span class="text-red-500 text-xs font-bold">[BAN]</span>' : ''}${u.is_muted ? '<span class="text-yellow-500 text-xs font-bold">[MUTE]</span>' : ''}</td><td class="py-3">${roleSelector}</td><td class="py-3 text-right flex justify-end gap-2">${canManage ? `<button onclick="adminAction(${u.id}, 'mute', ${!u.is_muted})" class="text-xs border ${u.is_muted ? 'border-yellow-500 text-yellow-500' : 'border-gray-600 text-gray-400'} px-2 py-1 rounded hover:bg-white/10">${u.is_muted ? 'Unmute' : 'Mute'}</button><button onclick="adminAction(${u.id}, 'ban', ${!u.is_banned})" class="text-xs border ${u.is_banned ? 'border-green-500 text-green-500' : 'border-red-500 text-red-500'} px-2 py-1 rounded hover:bg-white/10">${u.is_banned ? 'Unban' : 'Ban'}</button>${user.role === 'super_admin' ? `<button onclick="deleteUser(${u.id})" class="text-xs bg-red-900/50 text-white px-2 py-1 rounded hover:bg-red-900">Suppr</button>` : ''}` : '<span class="text-gray-600 italic text-xs">Intouchable</span>'}</td></tr>`;
            }).join('');
        }
        async function changeRole(userId, newRole) { if(!confirm(`Changer le rôle de cet utilisateur en ${newRole} ?`)) return loadAdminUsers(); try { await fetch('/api/users', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, action: 'set_role', value: newRole }) }); loadAdminUsers(); } catch(e) { alert("Action simulée"); } }
        async function adminAction(userId, action, value) { if(!confirm("Êtes-vous sûr ?")) return; try { await fetch('/api/users', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, action, value }) }); loadAdminUsers(); } catch(e) { alert("Action simulée"); } }
        async function deleteUser(userId) { if(!confirm("Supprimer ?")) return; try { await fetch('/api/users', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId }) }); loadAdminUsers(); } catch(e) { alert("Action simulée"); } }
        function loadAdminVideos() { const list = document.getElementById('admin-video-list'); list.innerHTML = videos.map(v => `<div class="flex items-center gap-4 bg-white/5 p-3 rounded border border-white/5"><img src="${v.thumbnail}" class="w-16 h-10 object-cover rounded"><div class="flex-1 min-w-0"><h4 class="text-white font-bold text-sm truncate">${v.title}</h4><p class="text-xs text-gray-500">ID: ${v.id}</p></div><button onclick="editVideo(${v.id})" class="text-xs bg-blue-600/20 text-blue-400 px-3 py-1 rounded hover:bg-blue-600/40">Edit</button><button onclick="deleteVideo(${v.id})" class="text-xs bg-red-600/20 text-red-400 px-3 py-1 rounded hover:bg-red-600/40">Suppr</button></div>`).join(''); }
        function resetVideoForm() { document.getElementById('editor-id').value = ''; document.getElementById('editor-input-title').value = ''; document.getElementById('editor-input-desc').value = ''; document.getElementById('editor-input-url').value = ''; document.getElementById('editor-input-thumb').value = ''; document.getElementById('editor-input-tags').value = ''; updateEditorPreview(); }
        function editVideo(id) { const v = videos.find(vid => vid.id === id); openEditor('edit'); document.getElementById('editor-id').value = v.id; document.getElementById('editor-input-title').value = v.title; document.getElementById('editor-input-desc').value = v.description || ''; document.getElementById('editor-input-url').value = v.url; document.getElementById('editor-input-thumb').value = v.thumbnail; document.getElementById('editor-input-cat').value = v.categories[0] || 'vs_all'; document.getElementById('editor-input-tags').value = v.tags ? v.tags.join(', ') : ''; updateEditorPreview(); }
        async function deleteVideo(id) { if(!confirm("Supprimer ?")) return; try { const res = await fetch('/api/videos', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) }); if(!res.ok) throw new Error(await res.text()); await loadVideos(); } catch(e) { console.warn("Mode simulation"); videos = videos.filter(v => v.id !== id); } renderVideos(); if(!document.getElementById('admin-panel').classList.contains('hidden')) loadAdminVideos(); alert("Vidéo supprimée !"); }

        function renderCommentHTML(c, allReplies, depth = 0) {
            const cReplies = allReplies.filter(r => r.parent_id === c.id);
            const dateStr = new Date(c.created_at).toLocaleDateString();
            let canDelete = false;
            if (user) { if (user.role === 'super_admin') canDelete = true; else if (user.role === 'admin') canDelete = true; else if (user.role === 'moderator') canDelete = true; else if (user.id === c.author_id) canDelete = true; }
            return `<div class="group animate-pulse-fast relative" style="animation: none;"><div class="flex gap-3 items-start"><img src="${c.avatar_url || DEFAULT_AVATAR}" class="w-8 h-8 rounded-full object-cover shrink-0 cursor-pointer hover:opacity-80" onclick="closeModal(); openPublicProfile(${c.author_id})"><div class="flex-1"><div class="flex items-baseline gap-2"><span class="text-xs font-bold text-white cursor-pointer hover:underline" onclick="closeModal(); openPublicProfile(${c.author_id})">${c.username}</span><span class="text-[10px] text-gray-500">${dateStr}</span>${canDelete ? `<button onclick="deleteComment(${c.id})" class="ml-2 text-red-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : ''}</div><p class="text-sm text-gray-300 mt-0.5 leading-relaxed">${c.content}</p><div class="flex items-center gap-4 mt-2"><button onclick="likeComment(${c.id})" class="flex items-center gap-1 text-[10px] text-gray-500 hover:text-white transition-colors"><i data-lucide="thumbs-up" class="w-3 h-3"></i> ${c.likes_count || 0}</button>${user && !user.is_muted && !user.is_banned ? `<button onclick="toggleReplyBox(${c.id})" class="text-[10px] text-gray-500 hover:text-white font-bold transition-colors">RÉPONDRE</button>` : ''}</div><div id="reply-box-${c.id}" class="hidden mt-3 pl-4 border-l border-white/10"><textarea id="reply-input-${c.id}" rows="1" class="w-full bg-transparent border-b border-white/20 text-white text-xs p-2 focus:outline-none" placeholder="Votre réponse..."></textarea><div class="flex justify-end mt-2"><button onclick="postReply(${c.id})" class="text-[10px] bg-white text-black font-bold px-3 py-1 rounded-full">Envoyer</button></div></div></div></div><div class="pl-11 mt-3 space-y-3">${cReplies.map(r => renderCommentHTML(r, allReplies, depth + 1)).join('')}</div></div>`;
        }
        async function deleteComment(commentId) { if(!confirm("Supprimer ?")) return; try { await fetch('/api/comments', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ commentId }) }); loadComments(currentVideoId, currentProfileId); } catch(e) { alert("Suppression simulée"); } }
        async function likeComment(id) { if (!user) return openAuthModal(); try { await fetch('/api/comments', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ commentId: id, userId: user.id }) }); loadComments(currentVideoId, currentProfileId); } catch (e) {} }
        async function postComment(context) { if (!user) return; const input = document.getElementById(`${context}-input`); const content = input.value.trim(); if (!content) return; const payload = { username: user.username, content: content, videoId: context === 'video' ? currentVideoId : null, targetUserId: context === 'profile' ? currentProfileId : null }; try { const res = await fetch('/api/comments', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); if (res.ok) { input.value = ''; loadComments(currentVideoId, currentProfileId); } } catch(e) { alert("Erreur envoi"); } }
        async function postReply(parentId) { const input = document.getElementById(`reply-input-${parentId}`); const content = input.value.trim(); if (!content) return; const isVideo = !document.getElementById('video-modal').classList.contains('hidden'); const payload = { username: user.username, content: content, parentId: parentId, videoId: isVideo ? currentVideoId : null, targetUserId: !isVideo ? currentProfileId : null }; try { const res = await fetch('/api/comments', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); if (res.ok) loadComments(currentVideoId, currentProfileId); } catch(e) { alert("Erreur envoi"); } }
        function toggleReplyBox(id) { document.getElementById(`reply-box-${id}`).classList.toggle('hidden'); }
        async function loadVideoStats(videoId) { try { let url = `/api/likes?videoId=${videoId}`; if (user) url += `&userId=${user.id}`; const res = await fetch(url); const data = await res.json(); document.getElementById('likes-count').textContent = data.stats.likes; document.getElementById('dislikes-count').textContent = data.stats.dislikes; } catch (e) {} }
        async function handleVideoLike(type) { if (!user) return closeModal() || openAuthModal(); try { await fetch('/api/likes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ videoId: currentVideoId, userId: user.id, type: type }) }); loadVideoStats(currentVideoId); } catch (e) {} }
        async function loadComments(videoId, profileId) { const listId = videoId ? 'comments-list' : 'profile-comments-list'; const list = document.getElementById(listId); let url = `/api/comments?`; if (videoId) url += `videoId=${videoId}`; else url += `targetUserId=${profileId}`; try { const res = await fetch(url); const allComments = await res.json(); if (allComments.length === 0) { list.innerHTML = '<div class="text-center text-gray-600 text-sm py-4">Aucun message.</div>'; return; } const roots = allComments.filter(c => !c.parent_id); const replies = allComments.filter(c => c.parent_id); list.innerHTML = roots.map(c => renderCommentHTML(c, replies)).join(''); lucide.createIcons(); } catch (e) { console.error(e); } }
        
        function handleFileSelect(input) { if(input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { document.getElementById('image-to-crop').src = e.target.result; document.getElementById('crop-container').classList.remove('hidden'); if(cropper) cropper.destroy(); cropper = new Cropper(document.getElementById('image-to-crop'), { aspectRatio: 1, viewMode: 1 }); }; reader.readAsDataURL(input.files[0]); } }
        function applyCrop() { if(!cropper) return; pendingAvatarBase64 = cropper.getCroppedCanvas({width:300,height:300}).toDataURL('image/jpeg', 0.8); document.getElementById('profile-avatar-preview').src = pendingAvatarBase64; document.getElementById('crop-container').classList.add('hidden'); cropper.destroy(); cropper = null; }
        function cancelCrop() { document.getElementById('crop-container').classList.add('hidden'); if(cropper) cropper.destroy(); cropper=null; document.getElementById('file-upload').value = ''; }
        async function saveProfile() { if(!user) return; const newBio = document.getElementById('edit-bio').value; const newUsername = document.getElementById('edit-username').value; const newPass = document.getElementById('edit-password').value; const finalAvatar = pendingAvatarBase64 || user.avatar_url; const saveBtn = document.querySelector('#profile-modal button'); const originalText = saveBtn.textContent; saveBtn.textContent = "Sauvegarde..."; saveBtn.disabled = true; try { const res = await fetch('/api/profile', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: user.id, bio: newBio, avatar_url: finalAvatar, new_username: newUsername, new_password: newPass }) }); const data = await res.json(); if(res.ok) { user = data; localStorage.setItem('jjk_user', JSON.stringify(user)); updateUIForUser(); closeProfileModal(); alert("Profil mis à jour !"); } else alert("Erreur: " + (data.error || "Inconnue")); } catch(e) { alert("Sauvegarde simulée (Mode Preview)"); } finally { saveBtn.textContent = originalText; saveBtn.disabled = false; } }
        function handleLogout() { user = null; localStorage.removeItem('jjk_user'); window.location.reload(); }
        function togglePassword(id, btn) { const input = document.getElementById(id); input.type = input.type === 'password' ? 'text' : 'password'; btn.innerHTML = input.type === 'password' ? '<i data-lucide="eye" class="w-4 h-4"></i>' : '<i data-lucide="eye-off" class="w-4 h-4"></i>'; lucide.createIcons(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        
        function openMembersModal() { 
            closeModal(); closeAdminPanel(); document.getElementById('members-modal').classList.remove('hidden'); 
            const grid = document.getElementById('members-grid'); grid.innerHTML = '...';
            fetch('/api/users?type=list').then(r=>r.json()).then(users => { grid.innerHTML = users.map(u => `<div class="bg-white/5 border border-white/5 rounded-xl p-4 flex items-center gap-4 hover:bg-white/10 transition-colors cursor-pointer group" onclick="closeMembersModal(); openPublicProfile(${u.id})"><img src="${u.avatar_url || DEFAULT_AVATAR}" class="w-14 h-14 rounded-full object-cover border-2 border-transparent group-hover:border-jjk-neon transition-colors"><div><h3 class="font-bold text-white group-hover:text-jjk-neon transition-colors">${u.username}</h3><div class="flex items-center gap-2 mt-1"><span class="text-[10px] px-2 py-0.5 rounded ${u.role === 'admin' ? 'bg-red-500/20 text-red-400' : 'bg-white/10 text-gray-400'} font-bold uppercase">${u.role === 'admin' ? 'Admin' : 'Membre'}</span><span class="text-xs text-gray-500">${new Date(u.created_at).toLocaleDateString()}</span></div></div></div>`).join(''); }).catch(() => grid.innerHTML = '<div class="col-span-full text-center text-red-500">Erreur</div>');
        }
        function closeMembersModal() { document.getElementById('members-modal').classList.add('hidden'); }
        
        // --- FONCTION AJOUTÉE : Affichage du profil public ---
        function renderPublicProfile(profileUser) {
            document.getElementById('public-username').textContent = profileUser.username;
            document.getElementById('public-bio').textContent = profileUser.bio || "Aucune bio.";
            document.getElementById('public-avatar').src = profileUser.avatar_url || DEFAULT_AVATAR;
            
            const roleEl = document.getElementById('public-role');
            roleEl.textContent = getRoleLabel(profileUser.role);
            roleEl.className = "px-2 py-0.5 rounded text-[10px] uppercase font-bold " + 
                (profileUser.role === 'admin' ? 'bg-red-500/20 text-red-400' : 
                 profileUser.role === 'super_admin' ? 'king-glow' : 
                 profileUser.role === 'moderator' ? 'bg-blue-500/20 text-blue-400' : 
                 'bg-white/10 text-gray-400');

            const date = new Date(profileUser.created_at).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('public-date').textContent = "Membre depuis le " + date;

            // Actions Admin (Bannir / Mute)
            const actionsDiv = document.getElementById('public-profile-admin-actions');
            actionsDiv.innerHTML = '';
            actionsDiv.classList.add('hidden');

            if (user && (user.role === 'admin' || user.role === 'super_admin')) {
                // On ne peut pas bannir un égal ou supérieur
                if (profileUser.role !== 'super_admin') {
                    actionsDiv.classList.remove('hidden');
                    
                    const btnBan = document.createElement('button');
                    btnBan.className = `px-3 py-1 rounded text-xs font-bold ${profileUser.is_banned ? 'bg-green-500/20 text-green-500' : 'bg-red-500/20 text-red-500'}`;
                    btnBan.textContent = profileUser.is_banned ? "Débannir" : "Bannir";
                    btnBan.onclick = () => adminAction(profileUser.id, 'ban', !profileUser.is_banned);
                    actionsDiv.appendChild(btnBan);

                    const btnMute = document.createElement('button');
                    btnMute.className = `px-3 py-1 rounded text-xs font-bold ${profileUser.is_muted ? 'bg-green-500/20 text-green-500' : 'bg-yellow-500/20 text-yellow-500'}`;
                    btnMute.textContent = profileUser.is_muted ? "Unmute" : "Mute";
                    btnMute.onclick = () => adminAction(profileUser.id, 'mute', !profileUser.is_muted);
                    actionsDiv.appendChild(btnMute);
                }
            }

            renderCommentInput('profile');
            loadComments(null, profileUser.id);
        }

        function openPublicProfile(id) { 
            currentProfileId = id; 
            closeModal(); 
            document.getElementById('public-profile-modal').classList.remove('hidden'); 
            fetch(`/api/users?id=${id}`)
                .then(r=>r.json())
                .then(data => { renderPublicProfile(data); })
                .catch(() => alert("Erreur profil")); 
        }
        function closePublicProfile() { document.getElementById('public-profile-modal').classList.add('hidden'); }
        function openProfileModal() { if(!user) return; document.getElementById('profile-modal').classList.remove('hidden'); document.getElementById('edit-username').value = user.username; document.getElementById('edit-bio').value = user.bio||''; document.getElementById('profile-avatar-preview').src = user.avatar_url || DEFAULT_AVATAR; }
        function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); }
        function openAuthModal() { document.getElementById('auth-modal').classList.remove('hidden'); switchAuthTab('login'); }
        function closeAuthModal() { document.getElementById('auth-modal').classList.add('hidden'); }
        function switchAuthTab(t) { document.getElementById('form-login').classList.toggle('hidden', t!=='login'); document.getElementById('form-signup').classList.toggle('hidden', t!=='signup'); document.getElementById('tab-login').className = t==='login' ? "pb-2 text-jjk-neon border-b-2 border-jjk-neon" : "pb-2 text-gray-500 hover:text-white"; document.getElementById('tab-signup').className = t==='signup' ? "pb-2 text-jjk-neon border-b-2 border-jjk-neon" : "pb-2 text-gray-500 hover:text-white"; }
        function handleLogin() { handleAuth('login'); }
        function handleSignup() { handleAuth('signup'); }
        
        async function handleAuth(type) { 
            const userField = document.getElementById(`${type}-username`); 
            const passField = document.getElementById(`${type}-password`); 
            const msg = document.getElementById('auth-msg'); 
            msg.textContent = "..."; 
            try { 
                const res = await fetch(`/api/auth?type=${type}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: userField.value, password: passField.value }) 
                }); 
                const data = await res.json(); 
                if (res.ok) { 
                    user = data; 
                    localStorage.setItem('jjk_user', JSON.stringify(user)); 
                    updateUIForUser(); 
                    closeAuthModal(); 
                    if(user.role==='admin' || user.role==='super_admin') location.reload(); 
                } else {
                    msg.textContent = data.error; 
                }
            } catch (e) { 
                console.error(e);
                msg.textContent = "Erreur de connexion"; 
            } 
        }

        document.getElementById('search-input').addEventListener('input', e => { searchQuery = e.target.value; renderVideos(); });
        document.addEventListener('DOMContentLoaded', () => { initApp(); const style = document.createElement('style'); style.innerHTML = `@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }`; document.head.appendChild(style); });
    </script>
</body>
</html>