<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archives du Fléau</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><path d=%22M50 5 C20 35 0 55 0 80 C0 95 20 100 50 100 C80 100 100 95 100 80 C100 55 80 35 50 5 Z%22 fill=%22%23000%22/><path d=%22M50 15 C35 45 15 65 15 80 C15 90 30 95 50 95 C70 95 85 90 85 80 C85 65 65 45 50 15 Z%22 fill=%22%234c1d95%22/><path d=%22M50 30 C40 55 30 70 30 80 C30 85 40 90 50 90 C60 90 70 85 70 80 C70 70 60 55 50 30 Z%22 fill=%22%238b5cf6%22/><circle cx=%2250%22 cy=%2275%22 r=%225%22 fill=%22white%22/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Oswald:wght@400;500;700&family=Rubik+Glitch&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { jjk: { black: '#050505', dark: '#0a0a0a', card: '#121212', purple: '#4c1d95', neon: '#8b5cf6', red: '#991b1b', blood: '#ef4444' } }, fontFamily: { oswald: ['Oswald', 'sans-serif'], cursed: ['Rubik Glitch', 'cursive'], body: ['Inter', 'sans-serif'], }, animation: { 'pulse-fast': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite', 'float': 'float 6s ease-in-out infinite' }, keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } } } } }
    </script>
    <style>
        body { background-color: #020202; background-image: radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.08) 0%, transparent 25%), radial-gradient(circle at 85% 30%, rgba(153, 27, 27, 0.05) 0%, transparent 25%); color: #e5e5e5; font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #0a0a0a; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 2px solid #0a0a0a; } ::-webkit-scrollbar-thumb:hover { background: #8b5cf6; }
        .glass-panel { background: rgba(18, 18, 18, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-card { background: rgba(26, 26, 26, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s ease; }
        .text-glow { text-shadow: 0 0 20px rgba(139, 92, 246, 0.5); }
        .king-glow { text-shadow: 0 0 15px rgba(239, 68, 68, 0.8); color: #ef4444; font-family: 'Rubik Glitch', cursive; letter-spacing: 1px; }
        .lord-glow { text-shadow: 0 0 15px rgba(139, 92, 246, 0.8); color: #a78bfa; font-family: 'Oswald', sans-serif; letter-spacing: 1px; text-transform: uppercase; font-weight: 700; }
        .card-hover:hover { transform: translateY(-5px) scale(1.01); box-shadow: 0 10px 40px -10px rgba(139, 92, 246, 0.25); border-color: rgba(139, 92, 246, 0.3); }
        .yt-input { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 14px; transition: all 0.2s; }
        .yt-input:focus { border-color: #8b5cf6; outline: none; background: rgba(139, 92, 246, 0.05); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1); }
        .yt-label { display: block; font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .banned-overlay { background: rgba(10, 5, 5, 0.95); backdrop-filter: blur(4px); border: 1px solid rgba(239, 68, 68, 0.3); display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; inset: 0; z-index: 20; }
        .notif-badge { position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #0a0a0a; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        .notif-dropdown { position: absolute; top: calc(100% + 10px); right: 0; width: 320px; max-height: 450px; overflow-y: auto; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); z-index: 60; display: none; transform-origin: top right; animation: scaleIn 0.2s ease-out; }
        .notif-item { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; transition: background 0.2s; cursor: pointer; }
        .notif-item:hover { background: rgba(255,255,255,0.03); }
        .notif-item.unread { background: rgba(139, 92, 246, 0.08); border-left: 3px solid #8b5cf6; }
        .notif-item.alert { border-left: 3px solid #ef4444; background: rgba(239, 68, 68, 0.08); }
        
        /* DUEL STYLES */
        .duel-bar-container { width: 100%; height: 24px; background: #1a1a1a; border-radius: 12px; overflow: hidden; position: relative; margin-top: 10px; display: flex; border: 1px solid rgba(255,255,255,0.1); }
        .duel-bar-red { height: 100%; background: linear-gradient(90deg, #991b1b, #ef4444); transition: width 0.5s ease; position: relative; }
        .duel-bar-blue { height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); flex: 1; transition: width 0.5s ease; }
        .duel-lightning { position: absolute; top: 0; bottom: 0; width: 2px; background: white; box-shadow: 0 0 10px white; z-index: 10; left: 50%; transform: translateX(-50%); }
        .duel-btn { flex: 1; text-align: center; padding: 8px; font-size: 12px; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; }
        .duel-btn.red:hover { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .duel-btn.blue:hover { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
        .admin-nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; color: #9ca3af; transition: all 0.2s; cursor: pointer; margin-bottom: 4px; font-family: 'Oswald', sans-serif; letter-spacing: 1px; }
        .admin-nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .admin-nav-item.active { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border-left: 3px solid #8b5cf6; }
        .stat-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="font-body overflow-x-hidden selection:bg-jjk-neon selection:text-white">

    <audio id="sound-hover" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="sound-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="sound-magic" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <header class="fixed w-full z-50 glass-panel border-b-0 border-white/5 shadow-2xl shadow-black/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-5" onmouseenter="playSound('hover')">
                    <div class="w-12 h-12 bg-black rounded-xl flex items-center justify-center border border-jjk-purple/30 shadow-[0_0_20px_rgba(139,92,246,0.15)] overflow-hidden relative group cursor-pointer hover:border-jjk-neon/50 transition-colors">
                        <svg viewBox="0 0 100 100" class="w-full h-full transform group-hover:scale-110 transition-transform duration-500">
                            <path d="M50 0 C20 30 0 50 0 75 C0 90 20 100 50 100 C80 100 100 90 100 75 C100 50 80 30 50 0 Z" fill="#050505"/>
                            <path d="M50 10 C30 40 10 60 10 80 C10 90 25 95 50 95 C75 95 90 90 90 80 C90 60 70 40 50 10 Z" fill="#4c1d95" class="animate-pulse"/>
                            <path d="M50 25 C40 55 25 70 25 80 C25 88 35 90 50 90 C65 90 75 88 75 80 C75 70 60 55 50 25 Z" fill="#8b5cf6"/>
                            <circle cx="50" cy="80" r="3" fill="white" class="group-hover:animate-ping"/>
                        </svg>
                    </div>
                    <div><h1 class="font-oswald text-2xl text-white tracking-[0.2em] uppercase font-bold text-glow">Archives</h1><span class="text-[10px] text-jjk-neon font-mono tracking-[0.3em] block -mt-1 uppercase opacity-80">Du Fléau</span></div>
                </div>
                <div class="hidden md:flex items-center gap-8">
                    <button onclick="openMembersModal()" onmouseenter="playSound('hover')" class="flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-white transition-colors group"><div class="p-2 rounded-full bg-white/5 group-hover:bg-white/10 transition-colors"><i data-lucide="users" class="w-4 h-4"></i></div><span class="font-oswald tracking-wide">Membres</span></button>
                    <button id="publish-btn" class="hidden flex items-center gap-2 text-sm font-bold text-white bg-gradient-to-r from-purple-900/50 to-jjk-purple/50 border border-white/10 px-5 py-2.5 rounded-xl shadow-[0_0_15px_rgba(139,92,246,0.1)] hover:shadow-[0_0_25px_rgba(139,92,246,0.3)] hover:border-jjk-neon/50 transition-all transform hover:-translate-y-0.5" onclick="openEditor('create')" onmouseenter="playSound('hover')"><i data-lucide="plus-circle" class="w-4 h-4"></i> <span class="font-oswald tracking-wide">Publier</span></button>
                    <button id="admin-link" class="hidden text-red-500 font-oswald uppercase tracking-wider hover:text-red-400 flex items-center gap-2 bg-red-900/10 px-4 py-2 rounded-lg border border-red-900/20 hover:bg-red-900/20 transition-all" onclick="openAdminPanel()" onmouseenter="playSound('hover')"><i data-lucide="shield-alert" class="w-4 h-4"></i> Admin</button>
                    <div class="relative hidden" id="notif-container"><button onclick="toggleNotifDropdown(); playSound('click')" class="text-gray-400 hover:text-white relative p-2.5 rounded-full hover:bg-white/5 transition-colors"><i data-lucide="bell" class="w-5 h-5"></i><span id="notif-badge" class="notif-badge hidden animate-bounce">0</span></button><div id="notif-dropdown" class="notif-dropdown custom-scrollbar"><div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/50 backdrop-blur sticky top-0 z-10"><span class="text-xs font-bold text-gray-300 uppercase tracking-widest">Notifications</span><button onclick="markAllRead()" class="text-[10px] text-jjk-neon hover:text-white font-bold transition-colors">Tout marquer lu</button></div><div id="notif-list"></div></div></div>
                    <div id="auth-buttons"><button onclick="openAuthModal(); playSound('click')" class="text-sm font-bold text-black bg-white hover:bg-gray-200 transition-colors px-6 py-2.5 rounded-xl shadow-[0_0_20px_rgba(255,255,255,0.1)] font-oswald tracking-wide">CONNEXION</button></div>
                    <div id="user-profile-btn" class="hidden flex items-center gap-3 cursor-pointer group pl-4 border-l border-white/5" onclick="openProfileModal(); playSound('click')"><div class="text-right hidden lg:block"><p class="text-white font-bold text-sm group-hover:text-jjk-neon transition-colors font-oswald tracking-wide" id="header-username">User</p><p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold" id="header-role">Grade 4</p></div><div class="relative"><img id="header-avatar" src="" class="w-10 h-10 rounded-full border border-white/10 group-hover:border-jjk-neon transition-all object-cover bg-black shadow-lg"><div class="absolute inset-0 rounded-full border border-white/10 group-hover:animate-ping opacity-20"></div></div></div>
                </div>
                <button class="md:hidden text-white p-2 rounded-lg hover:bg-white/5" onclick="toggleSidebar()"><i data-lucide="menu"></i></button>
            </div>
        </div>
    </header>

    <div class="flex pt-20 min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 w-64 glass-panel border-r border-white/5 border-t-0 border-b-0 border-l-0 transition-transform duration-300 ease-in-out z-40 pt-24 md:pt-0">
            <div class="p-6">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] mb-6 pl-4 border-l-2 border-jjk-purple">Filtres</h2>
                <nav class="space-y-2" id="category-list"></nav>
                <div class="mt-4 pt-4 border-t border-white/5">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] mb-4 pl-4 border-l-2 border-gray-700">Trier par</h2>
                    <div class="flex flex-col gap-2">
                        <button onclick="setSort('recent')" id="sort-recent" class="text-left px-4 py-2 text-sm text-jjk-neon font-bold bg-white/5 rounded-lg transition-colors">Plus Récents</button>
                        <button onclick="setSort('popular')" id="sort-popular" class="text-left px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors">Plus Populaires</button>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-6 lg:p-10 relative">
            <div class="relative z-10 mb-12 flex flex-col md:flex-row justify-between items-end gap-6 border-b border-white/5 pb-8">
                <div><h2 id="current-category-title" class="text-5xl md:text-6xl font-oswald font-bold text-white mb-3 uppercase tracking-tighter drop-shadow-2xl">Archives</h2><p class="text-gray-400 text-sm max-w-md font-light leading-relaxed border-l-2 border-jjk-neon pl-4">Accédez aux enregistrements interdits des combats et techniques maudites de l'ère moderne.</p></div>
                <div class="relative w-full md:w-auto group"><i data-lucide="search" class="absolute left-4 top-3.5 w-4 h-4 text-gray-500 group-focus-within:text-jjk-neon transition-colors"></i><input type="text" id="search-input" placeholder="Rechercher une archive..." class="bg-black/40 border border-white/10 text-white pl-11 pr-4 py-3 rounded-xl focus:outline-none focus:border-jjk-neon focus:ring-1 focus:ring-jjk-neon/50 w-full md:w-72 text-sm transition-all shadow-xl placeholder-gray-600"></div>
            </div>
            <div id="tags-filter-container" class="relative z-10 mb-6 flex flex-wrap gap-2"></div>
            <div id="video-grid" class="relative z-10 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-32 text-center opacity-50 animate-float"><div class="p-6 bg-white/5 rounded-full mb-6 border border-white/5"><i data-lucide="ghost" class="w-16 h-16 text-gray-500"></i></div><p class="font-oswald text-xl text-gray-400 uppercase tracking-widest">Aucune donnée trouvée</p><p class="text-sm text-gray-600 mt-2">Le vide infini...</p></div>
        </main>
    </div>

    <!-- MODALS -->
    <!-- AUTH -->
    <div id="auth-modal" class="fixed inset-0 z-[130] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4 transition-opacity duration-300"><div class="glass-card w-full max-w-sm rounded-2xl p-8 shadow-2xl relative border border-white/10 transform scale-100 transition-transform"><button onclick="closeAuthModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button><div class="flex gap-8 mb-10 text-sm font-bold uppercase tracking-widest justify-center"><button onclick="switchAuthTab('login')" id="tab-login" class="pb-2 text-jjk-neon border-b-2 border-jjk-neon transition-all">Connexion</button><button onclick="switchAuthTab('signup')" id="tab-signup" class="pb-2 text-gray-600 hover:text-white transition-all">Inscription</button></div><div id="form-login" class="space-y-5 animate-[fadeUp_0.3s_ease-out]"><input type="text" id="login-username" placeholder="Pseudo" class="yt-input"><div class="relative"><input type="password" id="login-password" placeholder="Mot de passe" class="yt-input pr-10"><button onclick="togglePassword('login-password', this)" class="absolute right-3 top-3 text-gray-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button></div><button onclick="handleLogin()" class="w-full bg-jjk-purple hover:bg-jjk-neon text-white font-bold py-3.5 rounded-xl text-sm uppercase tracking-widest transition-all shadow-[0_0_20px_rgba(76,29,149,0.4)] hover:shadow-[0_0_30px_rgba(139,92,246,0.6)] mt-2">Entrer</button></div><div id="form-signup" class="space-y-5 hidden animate-[fadeUp_0.3s_ease-out]"><input type="text" id="signup-username" placeholder="Pseudo" class="yt-input"><div class="relative"><input type="password" id="signup-password" placeholder="Mot de passe" class="yt-input pr-10"><button onclick="togglePassword('signup-password', this)" class="absolute right-3 top-3 text-gray-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button></div><button onclick="handleSignup()" class="w-full bg-white text-black hover:bg-gray-200 font-bold py-3.5 rounded-xl text-sm uppercase tracking-widest transition-all shadow-lg mt-2">Rejoindre</button></div><p id="auth-msg" class="mt-6 text-center text-xs text-red-400 font-mono min-h-[1.5em]"></p></div></div>

    <!-- VIDEO PLAYER -->
    <div id="video-modal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl hidden flex items-center justify-center p-0 md:p-6"><div class="bg-[#0a0a0a] border border-white/10 w-full max-w-[95rem] h-full md:h-[90vh] md:rounded-3xl shadow-2xl overflow-hidden relative flex flex-col md:flex-row animate-[scaleIn_0.3s_ease-out]"><button onclick="closeModal()" class="absolute top-4 right-4 z-50 text-white bg-black/50 hover:bg-white/10 p-2 rounded-full md:hidden transition-colors"><i data-lucide="x"></i></button><div class="w-full md:w-[72%] bg-black flex flex-col relative"><div class="flex-1 relative flex items-center justify-center bg-black" id="modal-player-container"></div><div class="p-6 border-b border-white/5 bg-[#0a0a0a] flex flex-col justify-between items-start"><div class="w-full flex justify-between items-start"><div><h3 id="modal-title" class="text-2xl font-oswald text-white uppercase font-bold leading-tight tracking-wide"></h3><div class="flex flex-wrap gap-2 mt-3" id="modal-tags"></div></div><div class="flex items-center gap-3 bg-white/5 rounded-full p-1.5 border border-white/5"><button onclick="handleVideoLike('like')" id="btn-like" class="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-jjk-neon"><i data-lucide="thumbs-up" class="w-4 h-4"></i> <span id="likes-count" class="text-xs font-bold">0</span></button><div class="w-[1px] h-5 bg-white/10"></div><button onclick="handleVideoLike('dislike')" id="btn-dislike" class="flex items-center gap-2 px-4 py-2 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-red-500"><i data-lucide="thumbs-down" class="w-4 h-4"></i> <span id="dislikes-count" class="text-xs font-bold">0</span></button></div></div>
    <!-- DUEL SECTION (NEW) -->
    <div id="duel-container" class="w-full mt-6 p-4 bg-white/5 rounded-xl border border-white/10 hidden">
        <div class="flex justify-between items-center mb-2">
            <div class="flex justify-between text-xs font-bold uppercase tracking-widest text-gray-400 flex-1">
                <span id="duel-red-name">Rouge</span>
                <span class="text-white">VS</span>
                <span id="duel-blue-name">Bleu</span>
            </div>
            <!-- Bouton Modifier Duel pour les Admins -->
            <button id="btn-edit-duel" onclick="editVideo(currentVideoId)" class="ml-4 text-[10px] text-gray-500 hover:text-white uppercase font-bold border border-white/10 px-2 py-1 rounded hidden"><i data-lucide="pencil" class="w-3 h-3 inline"></i> Modif</button>
        </div>
        <div class="flex gap-4"><button onclick="handleDuelVote('red')" class="duel-btn red">Voter</button><div class="flex-1"><div class="duel-bar-container"><div id="duel-bar-red" class="duel-bar-red" style="width: 50%;"></div><div class="duel-lightning"></div><div id="duel-bar-blue" class="duel-bar-blue" style="width: 50%;"></div></div><div class="flex justify-between text-[10px] font-mono mt-1 text-gray-500"><span id="duel-red-score">0</span><span id="duel-blue-score">0</span></div></div><button onclick="handleDuelVote('blue')" class="duel-btn blue">Voter</button></div>
    </div>
    </div></div><div class="w-full md:w-[28%] bg-[#121212] border-l border-white/5 flex flex-col h-full"><div class="p-5 border-b border-white/5 flex justify-between items-center hidden md:flex bg-[#121212]"><span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Discussion</span><button onclick="closeModal()" class="text-gray-400 hover:text-white hover:bg-white/10 p-2 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="flex-1 overflow-y-auto p-5 custom-scrollbar bg-[#121212]"><div class="mb-6 pb-6 border-b border-white/5"><p id="modal-desc" class="text-gray-400 text-sm leading-relaxed"></p></div><div id="video-comment-auth" class="mb-8"></div><div id="comments-list" class="space-y-6"></div></div></div></div></div>

    <!-- EDITOR -->
    <div id="editor-modal" class="fixed inset-0 z-[120] bg-black/95 backdrop-blur-xl hidden flex items-center justify-center p-0 md:p-6"><div class="glass-card w-full max-w-[90rem] h-full md:h-[90vh] md:rounded-3xl shadow-2xl overflow-hidden relative flex flex-col md:flex-row border border-white/10"><button onclick="closeEditor()" class="absolute top-4 right-4 z-50 text-white bg-black/50 p-2 rounded-full md:hidden"><i data-lucide="x"></i></button><div class="w-full md:w-[60%] bg-black flex flex-col border-r border-white/5"><div class="flex-1 relative flex items-center justify-center bg-black overflow-hidden" id="editor-preview-container"><p class="text-gray-600 font-oswald uppercase tracking-widest">Aperçu de la vidéo</p></div><div class="p-6 bg-[#0a0a0a] border-t border-white/5"><h3 class="text-gray-500 text-xs uppercase font-bold mb-3 tracking-widest">Aperçu Miniature</h3><div class="w-48 aspect-video bg-gray-900 rounded-lg overflow-hidden relative group border border-white/10"><img id="preview-thumb" src="" class="w-full h-full object-cover opacity-50 transition-opacity duration-300"><div class="absolute inset-0 flex items-center justify-center"><i data-lucide="image" class="w-6 h-6 text-gray-600"></i></div></div></div></div><div class="w-full md:w-[40%] bg-[#121212] flex flex-col h-full"><div class="p-8 border-b border-white/5 flex justify-between items-center"><h2 id="editor-title" class="text-2xl font-oswald text-white uppercase font-bold tracking-wide">Publier</h2><div class="flex gap-3"><button onclick="closeEditor()" class="text-gray-400 hover:text-white px-4 py-2 text-sm font-medium transition-colors">Annuler</button><button onclick="handleSaveEditor()" class="bg-jjk-purple hover:bg-jjk-neon text-white px-6 py-2 rounded-lg text-sm font-bold uppercase tracking-widest transition-all shadow-lg hover:shadow-purple-900/40">Enregistrer</button></div></div><div class="flex-1 overflow-y-auto p-8 custom-scrollbar space-y-6"><input type="hidden" id="editor-id"><div><label class="yt-label">Titre (requis)</label><input type="text" id="editor-input-title" class="yt-input" placeholder="Titre de la vidéo..."></div><div><label class="yt-label">Description</label><textarea id="editor-input-desc" class="yt-input h-32 resize-none leading-relaxed" placeholder="Parlez de votre vidéo aux spectateurs..."></textarea></div><div class="grid grid-cols-1 gap-6"><div><label class="yt-label">Lien Vidéo (Google Drive / MP4)</label><div class="relative"><input type="text" id="editor-input-url" class="yt-input pl-11" placeholder="https://..." oninput="updateEditorPreview()"><i data-lucide="link" class="absolute left-3.5 top-3.5 w-4 h-4 text-gray-500"></i></div></div><div><label class="yt-label">Miniature (URL Image)</label><div class="relative"><input type="text" id="editor-input-thumb" class="yt-input pl-11" placeholder="https://..." oninput="updateEditorPreview()"><i data-lucide="image" class="absolute left-3.5 top-3.5 w-4 h-4 text-gray-500"></i></div></div></div><div class="grid grid-cols-2 gap-6"><div><label class="yt-label">Catégorie</label><div class="relative"><select id="editor-input-cat" class="yt-input appearance-none cursor-pointer"><option value="vs_all">Vs All</option><option value="vs_people">Vs People</option></select><i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-gray-500 pointer-events-none"></i></div></div><div><label class="yt-label">Tags</label><input type="text" id="editor-input-tags" class="yt-input" placeholder="Ex: Gojo, Sukuna..."></div></div>
    <!-- CONFIGURATION DUEL -->
    <div class="pt-6 border-t border-white/5">
        <div class="flex items-center gap-3 mb-4">
            <input type="checkbox" id="editor-has-duel" class="w-4 h-4 rounded border-gray-600 bg-[#1a1a1a] text-jjk-neon focus:ring-jjk-neon" onchange="document.getElementById('duel-config').classList.toggle('hidden', !this.checked)">
            <label for="editor-has-duel" class="text-sm font-bold text-white uppercase tracking-wider select-none cursor-pointer">Activer le mode Duel</label>
        </div>
        <div id="duel-config" class="hidden space-y-4 pl-7 border-l border-white/10 ml-2">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="yt-label text-red-400">Équipe Rouge</label><input type="text" id="editor-duel-red" class="yt-input border-red-900/50 focus:border-red-500 placeholder-red-900/50" placeholder="Nom équipe 1" value="Rouge"></div>
                <div><label class="yt-label text-blue-400">Équipe Bleue</label><input type="text" id="editor-duel-blue" class="yt-input border-blue-900/50 focus:border-blue-500 placeholder-blue-900/50" placeholder="Nom équipe 2" value="Bleu"></div>
            </div>
        </div>
    </div>
    </div></div></div></div>

    <!-- MEMBERS -->
    <div id="members-modal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md hidden flex items-center justify-center p-4"><div class="glass-card w-full max-w-5xl h-[85vh] rounded-3xl shadow-2xl relative flex flex-col border border-white/10"><div class="flex justify-between items-center p-8 border-b border-white/10 shrink-0"><h2 class="text-3xl font-oswald text-white uppercase font-bold tracking-widest text-glow">Membres</h2><button onclick="closeMembersModal()" class="bg-white/5 hover:bg-white/10 p-3 rounded-full text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button></div><div class="flex-1 overflow-y-auto p-8 custom-scrollbar"><div id="members-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5"></div></div></div></div>
    
    <!-- MY PROFILE -->
    <div id="profile-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4"><div class="glass-card w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl relative border border-white/10"><button onclick="closeProfileModal()" class="absolute top-4 right-4 text-white z-10 bg-black/50 p-2 rounded-full hover:bg-black/70 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button><div class="h-40 bg-gradient-to-br from-jjk-purple via-black to-black relative overflow-hidden"><div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-30"></div></div><div class="px-10 pb-10 -mt-16"><div class="relative inline-block group"><img id="profile-avatar-preview" src="" class="w-32 h-32 rounded-full border-4 border-[#121212] object-cover bg-black cursor-pointer shadow-2xl" onclick="document.getElementById('file-upload').click()"><div class="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer pointer-events-none transition-all duration-300 backdrop-blur-sm"><i data-lucide="camera" class="text-white w-8 h-8"></i></div><input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleFileSelect(this)"></div><div id="crop-container" class="hidden mt-4 bg-black p-4 rounded-xl border border-white/10"><div class="h-64 w-full"><img id="image-to-crop" class="max-w-full max-h-full block"></div><div class="flex justify-end gap-2 mt-4"><button onclick="cancelCrop()" class="px-4 py-1.5 text-xs text-gray-400 border border-white/10 rounded hover:text-white transition-colors">Annuler</button><button onclick="applyCrop()" class="px-4 py-1.5 text-xs bg-white text-black rounded font-bold hover:bg-gray-200 transition-colors">Valider</button></div></div><div class="mt-8 space-y-6"><div><label class="yt-label">Pseudo</label><input type="text" id="edit-username" class="yt-input"></div><div><label class="yt-label">Mot de passe (Optionnel)</label><div class="relative"><input type="password" id="edit-password" class="yt-input pr-10"><button onclick="togglePassword('edit-password', this)" class="absolute right-3 top-3 text-gray-500 hover:text-white"><i data-lucide="eye" class="w-4 h-4"></i></button></div></div><div><label class="yt-label">Bio</label><textarea id="edit-bio" rows="3" class="yt-input resize-none"></textarea></div><div class="flex gap-4 pt-4"><button onclick="saveProfile()" class="flex-1 bg-white hover:bg-gray-200 text-black py-3 rounded-xl font-bold text-sm uppercase tracking-widest transition-colors shadow-lg">Sauvegarder</button><button onclick="handleLogout()" class="px-5 border border-red-900/50 text-red-500 hover:bg-red-900/10 rounded-xl text-sm font-bold uppercase tracking-widest transition-colors">Déconnexion</button></div></div></div></div></div>
    
    <!-- PUBLIC PROFILE -->
    <div id="public-profile-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md hidden flex items-center justify-center p-4"><div class="glass-card w-full max-w-2xl max-h-[90vh] rounded-3xl overflow-hidden shadow-2xl relative flex flex-col border border-white/10"><button onclick="closePublicProfile()" class="absolute top-4 right-4 text-white z-10 bg-black/50 p-2 rounded-full hover:bg-black/70 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button><div class="overflow-y-auto flex-1 custom-scrollbar"><div class="h-40 bg-gradient-to-r from-gray-900 via-[#1a1a1a] to-black relative"><div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-40"></div></div><div class="px-10 pb-10 -mt-16"><img id="public-avatar" src="" class="w-32 h-32 rounded-full border-4 border-[#121212] object-cover bg-black shadow-2xl relative z-10"><div class="mt-6"><div class="flex items-center gap-4"><h2 id="public-username" class="text-3xl font-oswald text-white font-bold tracking-wide"></h2><span id="public-role" class="px-3 py-1 rounded text-[10px] uppercase font-bold bg-white/10 text-gray-400 border border-white/5">Membre</span></div><p id="public-bio" class="text-gray-400 text-sm mt-3 leading-relaxed max-w-lg"></p><p id="public-date" class="text-xs text-gray-600 mt-4 font-mono uppercase tracking-widest"></p><div id="public-profile-admin-actions" class="mt-6 flex gap-3 hidden"></div></div><div class="mt-10 pt-8 border-t border-white/5"><h3 class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] mb-6">Mur de messages</h3><div id="profile-comment-auth"></div><div id="profile-comments-list" class="space-y-5 mt-8"></div></div></div></div></div></div>

    <!-- ADMIN PANEL -->
    <div id="admin-panel" class="fixed inset-0 z-[110] bg-black/95 hidden flex justify-center items-center p-4 md:p-8 backdrop-blur-xl"><div class="glass-card w-full max-w-7xl h-[90vh] rounded-3xl border border-white/10 flex overflow-hidden shadow-2xl relative"><div class="w-64 bg-[#0a0a0a] border-r border-white/5 p-6 flex flex-col"><div class="mb-10 flex items-center gap-3"><i data-lucide="shield-alert" class="w-8 h-8 text-red-600"></i><div><h2 class="font-oswald text-xl text-white uppercase tracking-widest font-bold">Admin</h2><p class="text-[10px] text-gray-500 font-mono">PANEL V3.0</p></div></div><nav class="flex-1 space-y-1"><button onclick="switchAdminTab('overview')" id="nav-overview" class="admin-nav-item active"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> Vue d'ensemble</button><button onclick="switchAdminTab('users')" id="nav-users" class="admin-nav-item"><i data-lucide="users" class="w-4 h-4"></i> Utilisateurs</button><button onclick="switchAdminTab('videos')" id="nav-videos" class="admin-nav-item"><i data-lucide="video" class="w-4 h-4"></i> Vidéos</button><button onclick="switchAdminTab('reports')" id="nav-reports" class="admin-nav-item"><i data-lucide="flag" class="w-4 h-4"></i> Signalements</button></nav><button onclick="closeAdminPanel()" class="mt-auto flex items-center gap-2 text-gray-500 hover:text-white transition-colors p-2 text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> Quitter</button></div><div class="flex-1 bg-[#121212] overflow-hidden flex flex-col relative"><div class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-[#0a0a0a]"><h3 id="admin-page-title" class="text-white font-oswald text-lg uppercase tracking-widest">Vue d'ensemble</h3><div class="flex items-center gap-4"><div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span class="text-xs text-gray-500 font-mono">SYSTEM ONLINE</span></div></div><div class="flex-1 overflow-y-auto p-8 custom-scrollbar relative"><div id="admin-view-overview" class="space-y-8 animate-[fadeUp_0.3s_ease-out]"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div class="stat-card"><div class="text-gray-500 text-xs uppercase tracking-widest mb-2">Total Membres</div><div class="text-3xl font-bold text-white font-oswald" id="stat-users">...</div></div><div class="stat-card"><div class="text-gray-500 text-xs uppercase tracking-widest mb-2">Total Vidéos</div><div class="text-3xl font-bold text-white font-oswald" id="stat-videos">...</div></div><div class="stat-card"><div class="text-gray-500 text-xs uppercase tracking-widest mb-2">Signalements</div><div class="text-3xl font-bold text-red-500 font-oswald" id="stat-reports">...</div></div><div class="stat-card"><div class="text-gray-500 text-xs uppercase tracking-widest mb-2">Taux de Ban</div><div class="text-3xl font-bold text-jjk-neon font-oswald" id="stat-bans">...</div></div></div></div><div id="admin-view-users" class="hidden animate-[fadeUp_0.3s_ease-out]"><table class="w-full text-left border-collapse"><thead><tr class="text-xs font-bold text-gray-500 uppercase border-b border-white/10 tracking-widest"><th class="pb-4 pl-4">ID</th><th class="pb-4">Utilisateur</th><th class="pb-4">Rôle</th><th class="pb-4 text-right pr-4">Actions</th></tr></thead><tbody id="admin-user-list" class="text-sm text-gray-300"></tbody></table></div><div id="admin-view-videos" class="hidden animate-[fadeUp_0.3s_ease-out]"><div class="flex justify-end mb-6"><button onclick="openEditor('create')" class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 uppercase tracking-wide transition-colors"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter une vidéo</button></div><div id="admin-video-list" class="space-y-3"></div></div><div id="admin-view-reports" class="hidden animate-[fadeUp_0.3s_ease-out]"><div id="admin-reports-list" class="space-y-4"></div></div></div></div></div></div>

    <script>
        let user = null;
        let currentCategory = 'all';
        let sortMode = 'recent';
        let searchQuery = '';
        let currentVideoId = null;
        let currentProfileId = null; 
        let currentDuelId = null;
        let cropper = null;
        let pendingAvatarBase64 = null;
        let videos = []; 

        const DEFAULT_AVATAR = "https://cdn.discordapp.com/attachments/990311724433408070/1445953911243411718/36280654-defaut-avatar-profil-icone-social-medias-utilisateur-image-gris-avatar-icone-vide-profil-silhouette-vecteur-illustration-vectoriel.jpg?ex=69323904&is=6930e784&hm=6beb888efc47cf175779fc766de696bc9c65e9a62a9f201d9a6e331723716798&";
        const categories = [{ id: 'all', name: 'Toutes les archives', icon: 'layers' },{ id: 'vs_all', name: 'Vs All', icon: 'swords' },{ id: 'vs_people', name: 'Vs People', icon: 'users' }];
        const defaultVideos = []; 

        function playSound(type) { const audio = document.getElementById(`sound-${type}`); if(audio) { audio.currentTime=0; audio.volume=0.3; audio.play().catch(e=>{}); } }

        async function initApp() {
            const storedUser = localStorage.getItem('jjk_user');
            if (storedUser) { 
                user = JSON.parse(storedUser); 
                updateUIForUser(); 
                startLiveStatusCheck(); 
            }
            await loadVideos();
            renderCategories();
            lucide.createIcons();
        }

        async function startLiveStatusCheck() {
            setInterval(async () => {
                if (!user) return; 
                try {
                    // FIX: /api instead of .netlify
                    const res = await fetch(`/api/users?id=${user.id}`);
                    if (res.status === 404) { alert("Votre compte a été supprimé par l'administration."); handleLogout(); return; }
                    if (res.ok) {
                        const newData = await res.json();
                        const justBanned = !user.is_banned && newData.is_banned;
                        const justUnbanned = user.is_banned && !newData.is_banned;
                        user = { ...user, ...newData };
                        localStorage.setItem('jjk_user', JSON.stringify(user));
                        if (justBanned) { renderVideos(); if (!document.getElementById('video-modal').classList.contains('hidden')) { closeModal(); alert("BANNI !"); } renderCommentInput('video'); renderCommentInput('profile'); }
                        if (justUnbanned) { renderVideos(); updateUIForUser(); }
                        // FIX: /api
                        const notifRes = await fetch(`/api/notifications?userId=${user.id}`);
                        if (notifRes.ok) { const notifData = await notifRes.json(); renderNotifications(notifData.list, notifData.unreadCount); }
                    }
                } catch (e) {}
            }, 3000); 
        }

        function renderNotifications(list, unreadCount) {
            const badge = document.getElementById('notif-badge');
            const listContainer = document.getElementById('notif-list');
            if (unreadCount > 0) { badge.textContent = unreadCount > 9 ? '9+' : unreadCount; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
            if (list.length === 0) { listContainer.innerHTML = '<div class="p-6 text-center text-gray-500 text-xs italic">Aucune nouvelle notification.</div>'; } else {
                listContainer.innerHTML = list.map(n => `
                    <div onclick="markRead(${n.id}, ${user.id})" class="notif-item ${!n.is_read ? 'unread' : ''} ${n.type === 'alert' ? 'alert' : ''}">
                        <div class="text-white mb-1.5 flex items-start gap-3">
                            <div class="mt-0.5">${getNotifIcon(n.type)}</div>
                            <span class="leading-snug">${n.message}</span>
                        </div>
                        <div class="text-[10px] text-gray-500 text-right font-mono">${new Date(n.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    </div>
                `).join('');
                lucide.createIcons();
            }
        }

        function getNotifIcon(type) {
            if (type === 'like') return '<i data-lucide="thumbs-up" class="w-4 h-4 text-blue-400"></i>';
            if (type === 'reply') return '<i data-lucide="message-circle" class="w-4 h-4 text-jjk-neon"></i>';
            if (type === 'profile') return '<i data-lucide="user" class="w-4 h-4 text-purple-400"></i>';
            if (type === 'alert') return '<i data-lucide="alert-triangle" class="w-4 h-4 text-red-500 fill-red-500/20"></i>';
            return '';
        }

        async function markRead(notifId, userId) { try { await fetch('/api/notifications', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ notifId, userId }) }); } catch(e) {} }
        async function markAllRead() { if(!user) return; try { await fetch('/api/notifications', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: user.id }) }); } catch(e) {} }
        function toggleNotifDropdown() { const dd = document.getElementById('notif-dropdown'); dd.style.display = dd.style.display === 'block' ? 'none' : 'block'; }
        window.onclick = function(event) { if (!event.target.closest('#notif-container')) { document.getElementById('notif-dropdown').style.display = 'none'; } }

        function setSort(mode) {
            sortMode = mode;
            document.getElementById('sort-recent').className = mode === 'recent' ? "text-left px-4 py-2 text-sm text-jjk-neon font-bold bg-white/5 rounded-lg transition-colors" : "text-left px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors";
            document.getElementById('sort-popular').className = mode === 'popular' ? "text-left px-4 py-2 text-sm text-jjk-neon font-bold bg-white/5 rounded-lg transition-colors" : "text-left px-4 py-2 text-sm text-gray-400 hover:text-white transition-colors";
            loadVideos();
        }

        async function loadVideos() {
            try { 
                const res = await fetch('/api/videos'); 
                if (!res.ok) throw new Error("Backend non dispo"); 
                videos = await res.json(); 
                if (sortMode === 'popular') videos.reverse(); 
                const allTags = new Set();
                videos.forEach(v => v.tags && v.tags.forEach(t => allTags.add(t)));
                renderTagsFilter(Array.from(allTags));
            } catch(e) { console.warn("Fallback"); videos = defaultVideos; }
            renderVideos();
        }

        function renderTagsFilter(tags) {
            const container = document.getElementById('tags-filter-container');
            container.innerHTML = tags.map(tag => 
                `<button onclick="searchQuery='${tag}'; renderVideos()" class="px-3 py-1 bg-[#1a1a1a] border border-white/10 rounded-full text-[10px] uppercase font-bold text-gray-400 hover:border-jjk-neon hover:text-white transition-all">#${tag}</button>`
            ).join('');
        }
        
        function getRoleLabel(role) {
            const isInnerCircle = user && (user.role === 'super_admin' || user.role === 'admin');
            if (role === 'super_admin') return isInnerCircle ? "Roi des Ténèbres" : "Admin"; 
            if (role === 'admin') return isInnerCircle ? "Seigneur des Ténèbres" : "Admin";
            if (role === 'moderator') return "Modérateur";
            return "Membre";
        }
        
        function getCalculatedGrade(userData) {
            if (userData.role !== 'user') return getRoleLabel(userData.role);
            const xp = userData.xp || 0;
            if (xp >= 1000) return "Grade 1";
            if (xp >= 500) return "Grade 2";
            if (xp >= 100) return "Grade 3";
            return "Grade 4";
        }

        function getRoleClass(userData) {
            const role = userData.role;
            const isInnerCircle = user && (user.role === 'super_admin' || user.role === 'admin');
            if (role === 'super_admin') { if (isInnerCircle) return "king-glow text-lg"; return "text-red-500 font-bold uppercase tracking-wider"; }
            if (role === 'admin') { if (isInnerCircle) return "lord-glow text-base"; return "text-red-500 font-bold uppercase tracking-wider"; }
            if (role === 'moderator') return "text-blue-400 font-bold uppercase tracking-wider";
            const xp = userData.xp || 0;
            if (xp >= 1000) return "text-jjk-neon font-bold uppercase tracking-wider text-glow"; 
            if (xp >= 500) return "text-purple-400 font-bold uppercase tracking-wider"; 
            return "text-gray-500 uppercase tracking-wider font-bold";
        }

        function updateUIForUser() {
            const authBtns = document.getElementById('auth-buttons');
            const profileBtn = document.getElementById('user-profile-btn');
            const adminLink = document.getElementById('admin-link');
            const publishBtn = document.getElementById('publish-btn');
            const notifContainer = document.getElementById('notif-container');

            if (user) {
                authBtns.classList.add('hidden'); profileBtn.classList.remove('hidden'); profileBtn.classList.add('flex');
                notifContainer.classList.remove('hidden');
                document.getElementById('header-username').textContent = user.username;
                const roleEl = document.getElementById('header-role');
                roleEl.textContent = getCalculatedGrade(user);
                roleEl.className = "text-[10px] " + getRoleClass(user);
                document.getElementById('header-avatar').src = user.avatar_url || DEFAULT_AVATAR;
                if (user.role === 'admin' || user.role === 'super_admin' || user.role === 'moderator') {
                    adminLink.classList.remove('hidden');
                    if (user.role !== 'moderator') { publishBtn.classList.remove('hidden'); publishBtn.classList.add('flex'); }
                } else { adminLink.classList.add('hidden'); publishBtn.classList.add('hidden'); publishBtn.classList.remove('flex'); }
            } else {
                authBtns.classList.remove('hidden'); profileBtn.classList.add('hidden'); profileBtn.classList.remove('flex'); notifContainer.classList.add('hidden');
                adminLink.classList.add('hidden'); publishBtn.classList.add('hidden'); publishBtn.classList.remove('flex');
            }
        }

        function renderCommentInput(context) {
            const containerId = context === 'video' ? 'video-comment-auth' : 'profile-comment-auth';
            const container = document.getElementById(containerId);
            if (!container) return;
            if (user) {
                if (user.is_muted) { container.innerHTML = `<div class="bg-red-900/10 border border-red-900/30 rounded-xl p-4 text-center"><p class="text-sm text-red-500 mb-2 font-bold uppercase tracking-wider flex items-center justify-center gap-2"><i data-lucide="mic-off" class="w-4 h-4"></i> Réduit au silence</p></div>`; } 
                else if (user.is_banned) { container.innerHTML = `<div class="bg-red-900/10 border border-red-900/30 rounded-xl p-4 text-center"><p class="text-sm text-red-500 mb-2 font-bold uppercase tracking-wider flex items-center justify-center gap-2"><i data-lucide="ban" class="w-4 h-4"></i> Compte Banni</p></div>`; } 
                else { container.innerHTML = `<div class="flex gap-4"><img src="${user.avatar_url || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full object-cover shrink-0 border border-white/10 shadow-lg"><div class="flex-1"><div class="relative"><textarea id="${context}-input" rows="1" placeholder="Ajouter un commentaire..." class="w-full bg-[#1a1a1a] border border-white/10 text-white text-sm focus:border-jjk-neon focus:ring-1 focus:ring-jjk-neon/50 py-3 px-4 resize-none transition-all rounded-xl shadow-inner"></textarea><button onclick="postComment('${context}'); playSound('magic')" class="absolute right-2 top-1.5 p-1.5 bg-white text-black rounded-lg hover:bg-jjk-neon hover:text-white transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button></div></div></div>`; }
            } else { container.innerHTML = `<div class="bg-white/5 rounded-xl p-6 text-center border border-white/5"><p class="text-sm text-gray-400 mb-4">Connectez-vous pour rejoindre la discussion</p><button onclick="${context === 'video' ? 'closeModal();' : 'closePublicProfile();'} openAuthModal()" class="text-xs bg-white text-black font-bold px-6 py-2 rounded-full hover:bg-gray-200 transition-colors uppercase tracking-wide">Se connecter</button></div>`; }
            lucide.createIcons();
        }

        function renderCategories() {
            const nav = document.getElementById('category-list');
            nav.innerHTML = categories.map(cat => `<button onclick="setCategory('${cat.id}'); playSound('click')" class="w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 transition-all duration-300 group ${currentCategory === cat.id ? 'bg-gradient-to-r from-jjk-purple/40 to-transparent text-white font-bold border-l-2 border-jjk-neon' : 'text-gray-400 hover:bg-white/5 hover:text-white'}"><i data-lucide="${cat.icon}" class="w-4 h-4 ${currentCategory === cat.id ? 'text-jjk-neon' : 'group-hover:text-white'}"></i><span class="font-medium text-sm tracking-wide">${cat.name}</span></button>`).join('');
            lucide.createIcons();
        }
        function renderVideos() {
            const grid = document.getElementById('video-grid');
            const filtered = videos.filter(v => (currentCategory === 'all' || v.categories.includes(currentCategory)) && (v.title.toLowerCase().includes(searchQuery.toLowerCase()) || (v.tags && v.tags.some(t => t.toLowerCase().includes(searchQuery.toLowerCase())))));
            if (filtered.length === 0) { grid.innerHTML = ''; document.getElementById('empty-state').classList.remove('hidden'); return; }
            document.getElementById('empty-state').classList.add('hidden');
            const isAdmin = user && (user.role === 'admin' || user.role === 'super_admin');
            const isBanned = user && user.is_banned;
            
            grid.innerHTML = filtered.map((v, i) => `
                <div class="group bg-[#121212] border border-white/5 rounded-2xl overflow-hidden card-hover transition-all duration-300 cursor-pointer relative" onclick="openModal(${v.id}); playSound('hover')" style="animation: fadeUp 0.5s ease-out ${i*0.1}s backwards">
                    <div class="relative aspect-video overflow-hidden">
                        <img src="${v.thumbnail}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700">
                        ${isBanned ? `<div class="banned-overlay"><i data-lucide="lock" class="w-12 h-12 text-red-600 mb-3"></i><span class="text-red-600 font-oswald uppercase tracking-widest text-xl font-bold text-glow">VOUS ÊTES BANNI</span></div>` : `<div class="absolute inset-0 bg-black/40 group-hover:bg-transparent transition-colors duration-300"></div><div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"><div class="bg-white/10 backdrop-blur-md p-4 rounded-full border border-white/20 shadow-[0_0_20px_rgba(255,255,255,0.2)] group-hover:scale-110 transition-transform"><i data-lucide="play" class="w-6 h-6 text-white fill-white"></i></div></div>`}
                        ${isAdmin ? `<div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-20"><button onclick="event.stopPropagation(); editVideo(${v.id});" class="bg-blue-600/80 p-2 rounded-full hover:bg-blue-500 text-white shadow-lg backdrop-blur-sm border border-white/20"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button><button onclick="event.stopPropagation(); deleteVideo(${v.id})" class="bg-red-600/80 p-2 rounded-full hover:bg-red-500 text-white shadow-lg backdrop-blur-sm border border-white/20"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>` : ''}
                    </div>
                    <div class="p-5">
                        <h3 class="text-white font-bold text-lg leading-tight mb-3 line-clamp-1 group-hover:text-jjk-neon transition-colors font-oswald tracking-wide">${v.title}</h3>
                        <div class="flex flex-wrap gap-2">${v.tags && v.tags.length ? v.tags.slice(0,3).map(t => `<span class="text-[10px] uppercase font-bold px-2.5 py-1 bg-white/5 text-gray-400 rounded-md border border-white/5 group-hover:border-white/10 transition-colors">${t}</span>`).join('') : ''}</div>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        }
        function setCategory(id) { currentCategory = id; renderCategories(); renderVideos(); toggleSidebar(); }
        function openModal(id) {
            if (user && user.is_banned) return;
            currentVideoId = id; const v = videos.find(v => v.id === id);
            document.getElementById('modal-title').textContent = v.title; document.getElementById('modal-desc').textContent = v.description || "";
            document.getElementById('modal-tags').innerHTML = v.tags ? v.tags.map(t => `<span class="px-2.5 py-1 bg-white/10 text-xs rounded-md text-gray-300 font-medium">${t}</span>`).join('') : '';
            const player = document.getElementById('modal-player-container');
            if (v.url.includes('drive.google.com')) { const embed = v.url.replace('/view', '/preview').replace('usp=drive_link', ''); player.innerHTML = `<iframe src="${embed}" width="100%" height="100%" class="absolute inset-0" frameborder="0" allowfullscreen></iframe>`; } else { player.innerHTML = '<p class="text-white font-oswald uppercase tracking-widest">Erreur Vidéo</p>'; }
            
            const duelContainer = document.getElementById('duel-container');
            duelContainer.classList.add('hidden');
            loadDuel(id);

            renderCommentInput('video'); loadComments(id); loadVideoStats(id);
            document.getElementById('video-modal').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('video-modal').classList.add('hidden'); document.getElementById('modal-player-container').innerHTML = ''; }

        async function loadDuel(videoId) {
            try {
                const res = await fetch(`/api/duels?videoId=${videoId}&userId=${user ? user.id : ''}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.duel) {
                        currentDuelId = data.duel.id;
                        updateDuelUI(data.duel, data.userVote);
                        document.getElementById('duel-container').classList.remove('hidden');
                        
                        // Show edit button if admin
                        if(user && (user.role === 'admin' || user.role === 'super_admin')) {
                            document.getElementById('btn-edit-duel').classList.remove('hidden');
                        } else {
                            document.getElementById('btn-edit-duel').classList.add('hidden');
                        }
                    }
                }
            } catch(e) {}
        }

        function updateDuelUI(duel, userVote) {
            document.getElementById('duel-red-name').textContent = duel.red_name;
            document.getElementById('duel-blue-name').textContent = duel.blue_name;
            document.getElementById('duel-red-score').textContent = duel.red_score;
            document.getElementById('duel-blue-score').textContent = duel.blue_score;
            
            const total = duel.red_score + duel.blue_score;
            const redPct = total === 0 ? 50 : (duel.red_score / total) * 100;
            const bluePct = 100 - redPct;
            
            document.getElementById('duel-bar-red').style.width = `${redPct}%`;
            document.getElementById('duel-bar-blue').style.width = `${bluePct}%`;

            const btns = document.querySelectorAll('.duel-btn');
            btns.forEach(b => {
                b.disabled = !!userVote;
                b.style.opacity = !!userVote ? 0.5 : 1;
            });
        }

        async function handleDuelVote(team) {
            if(!user) return openAuthModal();
            playSound('magic');
            try {
                const res = await fetch('/api/duels', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'vote', duelId: currentDuelId, userId: user.id, team })
                });
                if(res.ok) loadDuel(currentVideoId); 
            } catch(e) {}
        }

        async function reportComment(commentId) {
            if(!user) return;
            const reason = prompt("Pourquoi signaler ce commentaire ?");
            if(!reason) return;
            try {
                await fetch('/api/reports', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ commentId, reporterId: user.id, reason })
                });
                alert("Signalement envoyé aux Seigneurs.");
            } catch(e) {}
        }

        function openEditor(mode) { 
            closeAdminPanel(); 
            document.getElementById('editor-modal').classList.remove('hidden'); 
            const title = document.getElementById('editor-title'); 
            if (mode === 'create') { 
                title.textContent = "Publier une vidéo"; 
                resetVideoForm(); 
                document.getElementById('editor-has-duel').checked = false;
                document.getElementById('duel-config').classList.add('hidden');
            } else { 
                title.textContent = "Modifier la vidéo"; 
                document.getElementById('editor-has-duel').checked = false;
                document.getElementById('duel-config').classList.add('hidden');
                
                // Fetch existing duel data
                const vidId = document.getElementById('editor-id').value;
                if(vidId) {
                    fetch(`/api/duels?videoId=${vidId}`).then(r=>r.json()).then(d => {
                        if(d.duel) {
                            document.getElementById('editor-has-duel').checked = true;
                            document.getElementById('duel-config').classList.remove('hidden');
                            document.getElementById('editor-duel-red').value = d.duel.red_name;
                            document.getElementById('editor-duel-blue').value = d.duel.blue_name;
                        }
                    });
                }
            } 
            updateEditorPreview(); 
        }
        function closeEditor() { document.getElementById('editor-modal').classList.add('hidden'); document.getElementById('editor-preview-container').innerHTML = '<p class="text-gray-600 font-oswald uppercase tracking-widest">Aperçu de la vidéo</p>'; }
        function updateEditorPreview() { const url = document.getElementById('editor-input-url').value; const thumb = document.getElementById('editor-input-thumb').value; const previewContainer = document.getElementById('editor-preview-container'); const thumbPreview = document.getElementById('preview-thumb'); if (thumb) { thumbPreview.src = thumb; thumbPreview.classList.remove('opacity-50'); } else { thumbPreview.src = ""; thumbPreview.classList.add('opacity-50'); } if (url && url.includes('drive.google.com')) { const embed = url.replace('/view', '/preview').replace('usp=drive_link', ''); previewContainer.innerHTML = `<iframe src="${embed}" width="100%" height="100%" class="absolute inset-0" frameborder="0" allowfullscreen></iframe>`; } else { previewContainer.innerHTML = '<p class="text-gray-600 font-oswald uppercase tracking-widest">Aperçu vidéo non disponible</p>'; } }
        async function handleSaveEditor() { 
            const id = document.getElementById('editor-id').value; 
            const payload = { id: id ? parseInt(id) : null, title: document.getElementById('editor-input-title').value, description: document.getElementById('editor-input-desc').value, url: document.getElementById('editor-input-url').value, thumbnail: document.getElementById('editor-input-thumb').value, categories: [document.getElementById('editor-input-cat').value], tags: document.getElementById('editor-input-tags').value.split(',').map(t => t.trim()) }; 
            const method = id ? 'PUT' : 'POST'; 
            try { 
                const res = await fetch('/api/videos', { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                if(!res.ok) throw new Error(await res.text()); 
                await loadVideos();
                
                // --- DUEL LOGIC ---
                // Find ID of new video if created
                let targetId = id;
                if (!targetId && videos.length > 0) targetId = videos[0].id; // Simple assumption: newest video is first

                if (targetId) {
                    const hasDuel = document.getElementById('editor-has-duel').checked;
                    if (hasDuel) {
                        const redName = document.getElementById('editor-duel-red').value;
                        const blueName = document.getElementById('editor-duel-blue').value;
                        await fetch('/api/duels', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ action: 'upsert', videoId: targetId, redName, blueName })
                        });
                    } else {
                        await fetch('/api/duels', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ action: 'delete', videoId: targetId })
                        });
                    }
                }

            } catch(e) { console.warn("Simu"); } 
            closeEditor(); renderVideos(); alert("Vidéo enregistrée !"); 
        }

        function openAdminPanel() { if (!user || (user.role !== 'admin' && user.role !== 'super_admin' && user.role !== 'moderator')) return; document.getElementById('admin-panel').classList.remove('hidden'); switchAdminTab('users'); }
        function closeAdminPanel() { document.getElementById('admin-panel').classList.add('hidden'); }
        function switchAdminTab(tab) { document.getElementById('admin-section-users').classList.toggle('hidden', tab !== 'users'); document.getElementById('admin-section-videos').classList.toggle('hidden', tab !== 'videos'); document.getElementById('admin-tab-users').className = tab==='users' ? "px-6 py-2.5 rounded-lg text-sm font-bold uppercase transition-all admin-tab-active tracking-widest" : "px-6 py-2.5 rounded-lg text-sm font-bold uppercase transition-all bg-white/5 text-gray-400 hover:text-white tracking-widest hover:bg-white/10"; if (user.role === 'moderator') { document.getElementById('admin-tab-videos').style.display = 'none'; } else { document.getElementById('admin-tab-videos').className = tab==='videos' ? "px-6 py-2.5 rounded-lg text-sm font-bold uppercase transition-all admin-tab-active tracking-widest" : "px-6 py-2.5 rounded-lg text-sm font-bold uppercase transition-all bg-white/5 text-gray-400 hover:text-white tracking-widest hover:bg-white/10"; } if(tab === 'users') loadAdminUsers(); if(tab === 'videos') loadAdminVideos(); }
        async function loadAdminUsers() { const list = document.getElementById('admin-user-list'); list.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500 font-mono text-xs">Chargement des archives...</td></tr>'; let users = []; try { const res = await fetch('/api/users?type=list'); if (!res.ok) throw new Error("Fetch failed"); users = await res.json(); } catch (e) { users = []; } list.innerHTML = users.map(u => { let canManage = false; if (user.role === 'super_admin') canManage = true; else if (user.role === 'admin' && u.role !== 'super_admin' && u.role !== 'admin') canManage = true; else if (user.role === 'moderator' && u.role === 'user') canManage = true; let roleLabel = getCalculatedGrade(u); const isInnerCircle = user && (user.role === 'super_admin' || user.role === 'admin'); let badgeClass = "bg-white/5 text-gray-400 border border-white/5"; if (u.role === 'super_admin') { if (isInnerCircle) badgeClass = "king-glow border-none"; else badgeClass = "bg-red-900/20 text-red-400 border border-red-900/30"; } else if (u.role === 'admin') { if (isInnerCircle) badgeClass = "lord-glow border-none"; else badgeClass = "bg-red-900/20 text-red-400 border border-red-900/30"; } else if (u.role === 'moderator') { badgeClass = "bg-blue-900/20 text-blue-400 border border-blue-900/30"; } let roleSelector = `<span class="px-3 py-1 rounded text-xs ${badgeClass} font-bold uppercase tracking-wider">${roleLabel}</span>`; if (canManage && (user.role === 'super_admin' || (user.role === 'admin' && u.role !== 'admin'))) { roleSelector = `<select onchange="changeRole(${u.id}, this.value)" class="bg-[#121212] border border-white/20 text-xs rounded p-1.5 text-gray-300 focus:border-jjk-neon outline-none"><option value="user" ${u.role==='user'?'selected':''}>Membre</option><option value="moderator" ${u.role==='moderator'?'selected':''}>Modérateur</option><option value="admin" ${u.role==='admin'?'selected':''}>Admin</option></select>`; } return `<tr class="border-b border-white/5 hover:bg-white/5 transition-colors ${u.is_banned ? 'opacity-50' : ''}"><td class="py-4 pl-4 font-mono text-gray-600 text-xs">#${u.id}</td><td class="py-4 flex items-center gap-4"><img src="${u.avatar_url || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full bg-black object-cover border border-white/10 shadow-md"><span class="font-bold text-white text-sm font-oswald tracking-wide">${u.username}</span>${u.is_banned ? '<span class="text-red-500 text-[10px] font-bold border border-red-500/50 px-1.5 py-0.5 rounded ml-2 uppercase">Banni</span>' : ''}${u.is_muted ? '<span class="text-yellow-500 text-[10px] font-bold border border-yellow-500/50 px-1.5 py-0.5 rounded ml-2 uppercase">Mute</span>' : ''}</td><td class="py-4">${roleSelector}</td><td class="py-4 text-right pr-4 flex justify-end gap-2">${canManage ? `<button onclick="adminAction(${u.id}, 'mute', ${!u.is_muted})" class="text-[10px] font-bold border ${u.is_muted ? 'border-yellow-500/50 text-yellow-500 hover:bg-yellow-500/10' : 'border-gray-600 text-gray-400 hover:bg-white/10'} px-3 py-1.5 rounded transition-all uppercase">${u.is_muted ? 'Unmute' : 'Mute'}</button><button onclick="adminAction(${u.id}, 'ban', ${!u.is_banned})" class="text-[10px] font-bold border ${u.is_banned ? 'border-green-500/50 text-green-500 hover:bg-green-500/10' : 'border-red-500/50 text-red-500 hover:bg-red-500/10'} px-3 py-1.5 rounded transition-all uppercase">${u.is_banned ? 'Unban' : 'Ban'}</button>${user.role === 'super_admin' ? `<button onclick="deleteUser(${u.id})" class="text-[10px] font-bold bg-red-900/30 text-red-400 px-3 py-1.5 rounded hover:bg-red-900/50 transition-all uppercase ml-1 border border-red-900/50">Suppr</button>` : ''}` : '<span class="text-gray-700 italic text-[10px] uppercase tracking-widest pr-2">Intouchable</span>'}</td></tr>`; }).join(''); }
        async function changeRole(userId, newRole) { if(!confirm(`Changer le rôle de cet utilisateur en ${newRole} ?`)) return loadAdminUsers(); try { await fetch('/api/users', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, action: 'set_role', value: newRole }) }); loadAdminUsers(); } catch(e) { alert("Action simulée"); } }
        async function adminAction(userId, action, value) { if(!confirm("Êtes-vous sûr ?")) return; try { await fetch('/api/users', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId, action, value }) }); loadAdminUsers(); } catch(e) { alert("Action simulée"); } }
        async function deleteUser(userId) { if(!confirm("Supprimer DÉFINITIVEMENT cet utilisateur ?")) return; try { await fetch('/api/users', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId }) }); loadAdminUsers(); } catch(e) { alert("Action simulée"); } }
        function loadAdminVideos() { const list = document.getElementById('admin-video-list'); list.innerHTML = videos.map(v => `<div class="flex items-center gap-5 bg-white/5 p-4 rounded-xl border border-white/5 hover:bg-white/10 transition-colors"><img src="${v.thumbnail}" class="w-24 h-14 object-cover rounded-lg shadow-md"><div class="flex-1 min-w-0"><h4 class="text-white font-bold text-sm truncate font-oswald tracking-wide">${v.title}</h4><p class="text-xs text-gray-500 font-mono mt-1">ID: ${v.id}</p></div><div class="flex gap-2"><button onclick="editVideo(${v.id})" class="text-xs bg-blue-900/30 text-blue-400 border border-blue-900/50 px-3 py-1.5 rounded-lg hover:bg-blue-900/50 transition-colors font-bold uppercase">Edit</button><button onclick="deleteVideo(${v.id})" class="text-xs bg-red-900/30 text-red-400 border border-red-900/50 px-3 py-1.5 rounded-lg hover:bg-red-900/50 transition-colors font-bold uppercase">Suppr</button></div></div>`).join(''); }
        function resetVideoForm() { document.getElementById('editor-id').value = ''; document.getElementById('editor-input-title').value = ''; document.getElementById('editor-input-desc').value = ''; document.getElementById('editor-input-url').value = ''; document.getElementById('editor-input-thumb').value = ''; document.getElementById('editor-input-tags').value = ''; updateEditorPreview(); }
        function editVideo(id) { const v = videos.find(vid => vid.id === id); openEditor('edit'); document.getElementById('editor-id').value = v.id; document.getElementById('editor-input-title').value = v.title; document.getElementById('editor-input-desc').value = v.description || ''; document.getElementById('editor-input-url').value = v.url; document.getElementById('editor-input-thumb').value = v.thumbnail; document.getElementById('editor-input-cat').value = v.categories[0] || 'vs_all'; document.getElementById('editor-input-tags').value = v.tags ? v.tags.join(', ') : ''; updateEditorPreview(); }
        async function deleteVideo(id) { if(!confirm("Supprimer cette vidéo ?")) return; try { const res = await fetch('/api/videos', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) }); if(!res.ok) throw new Error(await res.text()); await loadVideos(); } catch(e) { console.warn("Mode simulation"); videos = videos.filter(v => v.id !== id); } renderVideos(); if(!document.getElementById('admin-panel').classList.contains('hidden')) loadAdminVideos(); alert("Vidéo supprimée !"); }

        function renderCommentHTML(c, allReplies, depth = 0) {
            const cReplies = allReplies.filter(r => r.parent_id === c.id);
            const dateStr = new Date(c.created_at).toLocaleDateString();
            let canDelete = false;
            if (user) { if (user.role === 'super_admin') canDelete = true; else if (user.role === 'admin') canDelete = true; else if (user.role === 'moderator') canDelete = true; else if (user.id === c.author_id) canDelete = true; }
            return `<div class="group relative bg-white/5 rounded-xl p-4 mb-3 border border-white/5 hover:border-white/10 transition-colors"><div class="flex gap-4 items-start"><img src="${c.avatar_url || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full object-cover shrink-0 cursor-pointer hover:opacity-80 border border-white/10 shadow-sm" onclick="closeModal(); openPublicProfile(${c.author_id})"><div class="flex-1"><div class="flex items-baseline gap-3 mb-1"><span class="text-sm font-bold text-white cursor-pointer hover:text-jjk-neon transition-colors font-oswald tracking-wide" onclick="closeModal(); openPublicProfile(${c.author_id})">${c.username}</span><span class="text-[10px] text-gray-500 font-mono">${dateStr}</span>${canDelete ? `<button onclick="deleteComment(${c.id})" class="ml-auto text-gray-600 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>` : ''}<button onclick="reportComment(${c.id})" class="text-gray-600 hover:text-yellow-500 transition-colors ml-2" title="Signaler"><i data-lucide="flag" class="w-3.5 h-3.5"></i></button></div><p class="text-sm text-gray-300 leading-relaxed">${c.content}</p><div class="flex items-center gap-5 mt-3"><button onclick="likeComment(${c.id}); playSound('click')" class="flex items-center gap-1.5 text-[11px] font-bold text-gray-500 hover:text-jjk-neon transition-colors group/like"><i data-lucide="thumbs-up" class="w-3.5 h-3.5 group-hover/like:scale-110 transition-transform"></i> ${c.likes_count || 0}</button>${user && !user.is_muted && !user.is_banned ? `<button onclick="toggleReplyBox(${c.id})" class="text-[10px] text-gray-500 hover:text-white font-bold transition-colors uppercase tracking-wider">Répondre</button>` : ''}</div><div id="reply-box-${c.id}" class="hidden mt-4 pl-4 border-l-2 border-white/10"><div class="relative"><textarea id="reply-input-${c.id}" rows="1" class="w-full bg-black/50 border border-white/10 text-white text-xs p-3 focus:outline-none focus:border-jjk-neon rounded-lg" placeholder="Votre réponse..."></textarea><button onclick="postReply(${c.id}); playSound('magic')" class="absolute right-2 top-2 p-1 bg-white text-black rounded hover:bg-gray-200"><i data-lucide="send" class="w-3 h-3"></i></button></div></div></div></div></div><div class="pl-8 space-y-3 border-l border-white/5 ml-5">${cReplies.map(r => renderCommentHTML(r, allReplies, depth + 1)).join('')}</div>`;
        }
        async function deleteComment(commentId) { if(!confirm("Supprimer ce message ?")) return; try { await fetch('/api/comments', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ commentId }) }); loadComments(currentVideoId, currentProfileId); } catch(e) { alert("Suppression simulée"); } }
        async function likeComment(id) { if (!user) return openAuthModal(); try { await fetch('/api/comments', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ commentId: id, userId: user.id }) }); loadComments(currentVideoId, currentProfileId); } catch (e) {} }
        async function postComment(context) { if (!user) return; const input = document.getElementById(`${context}-input`); const content = input.value.trim(); if (!content) return; const payload = { username: user.username, content: content, videoId: context === 'video' ? currentVideoId : null, targetUserId: context === 'profile' ? currentProfileId : null }; try { const res = await fetch('/api/comments', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); if (res.ok) { input.value = ''; loadComments(currentVideoId, currentProfileId); } } catch(e) { alert("Erreur envoi"); } }
        async function postReply(parentId) { const input = document.getElementById(`reply-input-${parentId}`); const content = input.value.trim(); if (!content) return; const isVideo = !document.getElementById('video-modal').classList.contains('hidden'); const payload = { username: user.username, content: content, parentId: parentId, videoId: isVideo ? currentVideoId : null, targetUserId: !isVideo ? currentProfileId : null }; try { const res = await fetch('/api/comments', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }); if (res.ok) { loadComments(currentVideoId, currentProfileId); playSound('magic'); } } catch(e) { alert("Erreur envoi"); } }
        function toggleReplyBox(id) { document.getElementById(`reply-box-${id}`).classList.toggle('hidden'); }
        async function loadVideoStats(videoId) { try { let url = `/api/likes?videoId=${videoId}`; if (user) url += `&userId=${user.id}`; const res = await fetch(url); const data = await res.json(); document.getElementById('likes-count').textContent = data.stats.likes; document.getElementById('dislikes-count').textContent = data.stats.dislikes; } catch (e) {} }
        async function handleVideoLike(type) { if (!user) return closeModal() || openAuthModal(); playSound('magic'); try { await fetch('/api/likes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ videoId: currentVideoId, userId: user.id, type: type }) }); loadVideoStats(currentVideoId); } catch (e) {} }
        async function loadComments(videoId, profileId) { const listId = videoId ? 'comments-list' : 'profile-comments-list'; const list = document.getElementById(listId); let url = `/api/comments?`; if (videoId) url += `videoId=${videoId}`; else url += `targetUserId=${profileId}`; try { const res = await fetch(url); const allComments = await res.json(); if (allComments.length === 0) { list.innerHTML = '<div class="text-center text-gray-500 text-sm py-10 italic">Aucun message pour le moment.</div>'; return; } const roots = allComments.filter(c => !c.parent_id); const replies = allComments.filter(c => c.parent_id); list.innerHTML = roots.map(c => renderCommentHTML(c, replies)).join(''); lucide.createIcons(); } catch (e) { console.error(e); } }
        
        function handleFileSelect(input) { if(input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { document.getElementById('image-to-crop').src = e.target.result; document.getElementById('crop-container').classList.remove('hidden'); if(cropper) cropper.destroy(); cropper = new Cropper(document.getElementById('image-to-crop'), { aspectRatio: 1, viewMode: 1 }); }; reader.readAsDataURL(input.files[0]); } }
        function applyCrop() { if(!cropper) return; pendingAvatarBase64 = cropper.getCroppedCanvas({width:300,height:300}).toDataURL('image/jpeg', 0.8); document.getElementById('profile-avatar-preview').src = pendingAvatarBase64; document.getElementById('crop-container').classList.add('hidden'); cropper.destroy(); cropper = null; }
        function cancelCrop() { document.getElementById('crop-container').classList.add('hidden'); if(cropper) cropper.destroy(); cropper=null; document.getElementById('file-upload').value = ''; }
        async function saveProfile() { if(!user) return; const newBio = document.getElementById('edit-bio').value; const newUsername = document.getElementById('edit-username').value; const newPass = document.getElementById('edit-password').value; const finalAvatar = pendingAvatarBase64 || user.avatar_url; const saveBtn = document.querySelector('#profile-modal button'); const originalText = saveBtn.textContent; saveBtn.textContent = "Sauvegarde..."; saveBtn.disabled = true; try { const res = await fetch('/api/profile', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: user.id, bio: newBio, avatar_url: finalAvatar, new_username: newUsername, new_password: newPass }) }); const data = await res.json(); if(res.ok) { user = data; localStorage.setItem('jjk_user', JSON.stringify(user)); updateUIForUser(); closeProfileModal(); alert("Profil mis à jour !"); } else alert("Erreur: " + (data.error || "Inconnue")); } catch(e) { alert("Sauvegarde simulée (Mode Preview)"); } finally { saveBtn.textContent = originalText; saveBtn.disabled = false; } }
        function handleLogout() { user = null; localStorage.removeItem('jjk_user'); window.location.reload(); }
        function togglePassword(id, btn) { const input = document.getElementById(id); input.type = input.type === 'password' ? 'text' : 'password'; btn.innerHTML = input.type === 'password' ? '<i data-lucide="eye" class="w-4 h-4"></i>' : '<i data-lucide="eye-off" class="w-4 h-4"></i>'; lucide.createIcons(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        
        function openMembersModal() { 
            closeModal(); closeAdminPanel(); document.getElementById('members-modal').classList.remove('hidden'); 
            const grid = document.getElementById('members-grid'); grid.innerHTML = '...';
            // FIX: /api instead of .netlify
            fetch('/api/users?type=list').then(r=>r.json()).then(users => { grid.innerHTML = users.map(u => `<div class="bg-white/5 border border-white/5 rounded-2xl p-5 flex items-center gap-5 hover:bg-white/10 transition-colors cursor-pointer group" onclick="closeMembersModal(); openPublicProfile(${u.id}); playSound('hover')"><img src="${u.avatar_url || DEFAULT_AVATAR}" class="w-16 h-16 rounded-full object-cover border-2 border-transparent group-hover:border-jjk-neon transition-colors shadow-lg"><div><h3 class="font-bold text-white text-lg group-hover:text-jjk-neon transition-colors font-oswald tracking-wide">${u.username}</h3><div class="flex items-center gap-2 mt-1.5"><span class="text-[10px] px-2.5 py-0.5 rounded ${u.role === 'admin' ? 'bg-red-900/30 text-red-400 border border-red-900/50' : 'bg-white/10 text-gray-400 border border-white/5'} font-bold uppercase tracking-wider">${u.role === 'admin' ? 'Admin' : getCalculatedGrade(u)}</span></div></div></div>`).join(''); }).catch(() => grid.innerHTML = '<div class="col-span-full text-center text-red-500">Erreur</div>');
        }
        function closeMembersModal() { document.getElementById('members-modal').classList.add('hidden'); }
        // FIX: /api instead of .netlify
        function openPublicProfile(id) { currentProfileId = id; closeModal(); document.getElementById('public-profile-modal').classList.remove('hidden'); fetch(`/api/users?id=${id}`).then(r=>r.json()).then(data => { renderPublicProfile(data); }).catch(() => alert("Erreur profil")); }
        function closePublicProfile() { document.getElementById('public-profile-modal').classList.add('hidden'); }
        function openProfileModal() { if(!user) return; document.getElementById('profile-modal').classList.remove('hidden'); document.getElementById('edit-username').value = user.username; document.getElementById('edit-bio').value = user.bio||''; document.getElementById('profile-avatar-preview').src = user.avatar_url || DEFAULT_AVATAR; }
        function closeProfileModal() { document.getElementById('profile-modal').classList.add('hidden'); }
        function openAuthModal() { document.getElementById('auth-modal').classList.remove('hidden'); switchAuthTab('login'); }
        function closeAuthModal() { document.getElementById('auth-modal').classList.add('hidden'); }
        function switchAuthTab(t) { document.getElementById('form-login').classList.toggle('hidden', t!=='login'); document.getElementById('form-signup').classList.toggle('hidden', t!=='signup'); document.getElementById('tab-login').className = t==='login' ? "pb-2 text-jjk-neon border-b-2 border-jjk-neon transition-colors" : "pb-2 text-gray-500 hover:text-white transition-colors"; document.getElementById('tab-signup').className = t==='signup' ? "pb-2 text-jjk-neon border-b-2 border-jjk-neon transition-colors" : "pb-2 text-gray-500 hover:text-white transition-colors"; }
        function handleLogin() { handleAuth('login'); }
        function handleSignup() { handleAuth('signup'); }
        // FIX: /api instead of .netlify
        async function handleAuth(type) { const userField = document.getElementById(`${type}-username`); const passField = document.getElementById(`${type}-password`); const msg = document.getElementById('auth-msg'); msg.textContent = "..."; try { const res = await fetch(`/api/auth?type=${type}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: userField.value, password: passField.value }) }); const data = await res.json(); if (res.ok) { user = data; localStorage.setItem('jjk_user', JSON.stringify(user)); updateUIForUser(); closeAuthModal(); if(user.role==='admin' || user.role==='super_admin') location.reload(); } else msg.textContent = data.error; } catch (e) { msg.textContent = "Erreur"; } }

        document.getElementById('search-input').addEventListener('input', e => { searchQuery = e.target.value; renderVideos(); });
        document.addEventListener('DOMContentLoaded', () => { initApp(); const style = document.createElement('style'); style.innerHTML = `@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }`; document.head.appendChild(style); });
    </script>
</body>
</html>